## å‰è¨€

åœ¨ä¸Šä¸€ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº† `NestJS CLI` çš„ç”¨æ³•ï¼Œå¾—åˆ°äº†ä¸€å¥—åŸºç¡€çš„é¡¹ç›®å·¥ç¨‹ã€‚æœ€å¼€å§‹åšé¡¹ç›®å¯¹æ¯”çš„æ—¶å€™ä¹Ÿæåˆ°è¿‡ï¼Œ`NestJS` ä½œä¸ºä¸€æ¬¾**è‡ªå®šä¹‰ç¨‹åº¦è¾ƒé«˜**çš„æ¡†æ¶ï¼Œ`CLI` ç›´æ¥æä¾›çš„åŸºç¡€åŠŸèƒ½è™½ç„¶å¹¶ä¸å®Œå–„ï¼Œä½†åŒæ—¶ä¹Ÿä¸ºå¼€å‘è€…æä¾›äº†éå¸¸å¤šçš„å†…ç½®æˆ–é…å¥—çš„åŠŸèƒ½ä¾‹å¦‚**é«˜é€Ÿç¼“å­˜ã€æ—¥å¿—æ‹¦æˆªã€è¿‡æ»¤å™¨ã€å¾®æœåŠ¡**ç­‰å¤šç§æ¨¡å—ï¼Œæ–¹ä¾¿å¼€å‘è€…æ ¹æ®è‡ªèº«çš„ä¸šåŠ¡éœ€æ±‚å®šåˆ¶é€‚åˆå½“å‰ä¸šåŠ¡çš„å·¥ç¨‹ã€‚

æœ¬ç« å°†æ ¹æ®ä¸šåŠ¡éœ€æ±‚æˆ–è€…å›¢é˜Ÿè§„èŒƒï¼Œé€‰æ‹©å¯¹åº”çš„æ¨¡å—æ­å»ºå‡ºä¸€ä¸ªç¬¦åˆè¦æ±‚çš„é€šç”¨æ€§è„šæ‰‹æ¶ã€‚

## Fastify

å¯¹äºç½‘å…³ç³»ç»Ÿæ¥è¯´ï¼Œæ— è®ºæ˜¯èµ„æºè¿˜æ˜¯ `API` æ¥å£æ•°æ®ï¼Œå®ƒéƒ½å°†æ‰¿æ‹…æ‰€æœ‰çš„è¯·æ±‚è½¬å‘ï¼Œè™½ç„¶å¤–å±‚å¯ä»¥æœ‰ `Nginx` åšè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œä½†å¦‚æœæ¡†æ¶æœ¬èº«çš„æ€§èƒ½è¶Šå¥½ï¼Œä¸šåŠ¡å®ç°çš„æ•ˆæœå°±ä¼šè¶Šå¥½ï¼ŒåŒæ—¶å¯¹ä¸šåŠ¡ä»£ç è¦æ±‚ä¹Ÿå¯ä»¥ç¨å¾®é™ä½ä¸€ç‚¹ã€‚

> æ¡†æ¶æˆ–è€…è¯­è¨€å¸¦æ¥çš„æ€§èƒ½æå‡è¿˜æ˜¯éå¸¸é‡è¦çš„ã€‚å¯ä»¥ç»™å¤§å®¶ä¸¾ä¸€ä¸ªæ˜æ˜¾çš„ä¾‹å­ï¼Œ**Windows** è‡ªå¸¦çš„ `VBS` è„šæœ¬å¯ä»¥æ“ä½œ **Excel**ï¼Œ`Java` æˆ–è€…å…¶ä»–è¯­è¨€æ¡†æ¶ä¹Ÿå¯ä»¥æ“ä½œ **Excel**ã€‚ä½†æ˜¯ï¼Œå…¶ä»–è¯­è¨€çš„æ“ä½œæ•ˆç‡ä¼šè¿œè¶… `VBS`ï¼Œå³ä½¿æ˜¯åœ¨æ“ä½œæ›´ä¸ºå¤æ‚æˆ–è€…æ–‡ä»¶è¯»å†™å†…å®¹æ›´å¤šçš„æƒ…å†µä¸‹ã€‚è¿™é‡Œæˆ‘ä»¬å¹¶ä¸å»æ·±ç©¶ä¸ºä»€ä¹ˆå…¶ä»–è¯­è¨€çš„é€Ÿåº¦ä¼šæ›´å¿«ï¼Œä½†æ˜¯å¯¹äºä¸€ä¸ªå¿«é€Ÿè¿­ä»£çš„ä¸šåŠ¡é¡¹ç›®æˆ–è€…å°å›¢é˜Ÿæ¥è¯´ï¼Œé€‰æ‹©æ•ˆç‡é«˜ã€æ€§èƒ½é«˜çš„æ¡†æ¶ä½œä¸ºå¼€å‘è¯­è¨€æ— ç–‘æ˜¯é™ä½æ•´ä½“æˆæœ¬æœ€å¥½çš„ä¸€ç§æ–¹å¼ã€‚

è€Œ `Nest` ä½œä¸ºä¸€ä¸ªä¸Šå±‚æ¡†æ¶ï¼Œå¯ä»¥é€šè¿‡é€‚é…å™¨æ¨¡å¼ä½¿å¾—åº•å±‚å¯ä»¥å…¼å®¹ä»»æ„ `HTTP` ç±»å‹çš„ `Node` æ¡†æ¶ï¼Œæœ¬èº«å†…ç½®çš„æ¡†æ¶æœ‰ä¸¤ç§ [Express](https://expressjs.com/) ä¸ [Fastify](https://www.fastify.io/)ã€‚

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c3aaf3b9e3b64b6ca5bd0afb3d7b1d4b~tplv-k3u1fbpfcp-watermark.image?)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ`Fastify` ä¸å…¶ä»–ä¸»æµ `HTTP` æ¡†æ¶å¯¹æ¯”ï¼Œå…¶åœ¨ **QPS**(**å¹¶å‘å¤„ç†è¯·æ±‚**)çš„æ•ˆç‡ä¸Šè¦è¿œè¶…å…¶ä»–æ¡†æ¶ï¼Œè¾¾åˆ°äº†å‡ ä¹ä¸¤å€çš„åŸºå‡†æµ‹è¯•ç»“æœï¼Œæ‰€ä»¥åœ¨ç½‘å…³ç³»ç»Ÿè¿™ä¸ªå¯¹æ€§èƒ½è¦æ±‚éå¸¸é«˜çš„é¡¹ç›®ä¸­ä½¿ç”¨ `Fastify` æ— ç–‘æ˜¯ä¸€ç§éå¸¸å¥½çš„é€‰æ‹©ã€‚

> å½“ç„¶å…·ä½“çš„æ€§èƒ½å¼€é”€ã€ä¼˜åŒ–å¤§éƒ¨åˆ†è¿˜æ˜¯ä¾èµ–ä¸šåŠ¡å¤æ‚åº¦ä»¥åŠä»£ç è´¨é‡ï¼Œæ¡†æ¶èƒ½å¤Ÿæä¾›çš„æ˜¯åªæ˜¯ä¸€å±‚åŸºç¡€æ¶æ„ã€‚èƒ½ä»è¿™å±‚æ¶æ„ä¸Šæ­å»ºå‡ºä»€ä¹ˆæ ·çš„äº§å“ï¼Œå–å†³äºå¼€å‘è€…è‡ªèº«ã€‚åŒæ—¶ï¼Œæˆ‘å¹¶ä¸æ˜¯é¼“åŠ±æ‰€æœ‰çš„é¡¹ç›®éƒ½ä½¿ç”¨ `Fastify`ï¼Œåœ¨ä¸šåŠ¡å¤æ‚åº¦ä»¥åŠå¯¹æ€§èƒ½è¦æ±‚å¹¶éååˆ†æ•æ„Ÿçš„é¡¹ç›®ä¸­ï¼Œ`Express` ä¹Ÿæ˜¯ä¸€ç§éå¸¸å¥½çš„é€‰æ‹©ã€‚ä½œä¸ºè€ç‰Œçš„æ¡†æ¶ï¼Œå®ƒç»å†äº†éå¸¸å¤šçš„å¤§å‹é¡¹ç›®å®æˆ˜çš„è€ƒéªŒä»¥åŠé•¿æœŸçš„è¿­ä»£ï¼Œæ‰€ä»¥ `Express` ç¤¾åŒºç”Ÿæ€éå¸¸çš„ä¸°å¯Œï¼Œé‡åˆ°ä»»ä½•çš„é—®é¢˜éƒ½å¯ä»¥å¿«é€Ÿæ‰¾åˆ°è§£å†³æ–¹æ¡ˆï¼Œè¿™ä¹Ÿæ˜¯ `NestJS` é‡‡ç”¨ `Express` ä½œä¸ºé»˜è®¤åŸºç¡€æ¡†æ¶çš„åŸå› ã€‚

ä»‹ç»å®Œ `Fastify` çš„ä¼˜åŠ¿ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹ç€æ‰‹æ”¹é€ æ¨¡æ¿é¡¹ç›®æ¡†æ¶ã€‚é¦–å…ˆï¼Œé€šè¿‡ `CLI` é»˜è®¤ç”Ÿæˆçš„é¡¹ç›®æ¡†æ¶ä¸­ï¼Œåº•å±‚å¹³å°ä½¿ç”¨çš„æ˜¯ `Express`ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  await app.listen(3000);
}
bootstrap();
```

æ¯•ç«Ÿ `Fastify` ä½œä¸ºå”¯äºŒå†…ç½®çš„å¹³å°ï¼Œæ•´ä½“çš„æ›¿æ¢è¿‡ç¨‹ä¼šéå¸¸é¡ºç•…ã€‚é¦–å…ˆï¼Œå®‰è£…å¯¹åº”çš„é€‚é…å™¨ä¾èµ– `@nestjs/platform-fastify`ã€‚å…¶æ¬¡ï¼Œä½¿ç”¨ `FastifyAdapter` æ›¿æ¢é»˜è®¤çš„ `Express` ã€‚

```ts
import { NestFactory } from '@nestjs/core';
import {
  FastifyAdapter,
  NestFastifyApplication,
} from '@nestjs/platform-fastify';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create<NestFastifyApplication>(
    AppModule,
    new FastifyAdapter(),
  );
  await app.listen(3000);
}
bootstrap();
```

## ç‰ˆæœ¬æ§åˆ¶

ä¹‹å‰å­¦ä¹ è¿‡ **DevOps** å°å†Œçš„åŒå­¦ï¼Œåº”è¯¥å¯¹ [GitLab OpenApi](https://docs.gitlab.com/ee/api/) æ¯”è¾ƒç†Ÿæ‚‰ï¼Œè‚¯å®šä¹Ÿä½¿ç”¨è¿‡è¿™æ ·çš„è¯·æ±‚ **https://gitlab.example.com/api/v4/projects** ï¼Œå¯ä»¥çœ‹å‡ºé“¾æ¥ä¸Šé¢æ˜¯å¸¦ v4 ç‰ˆæœ¬çš„ã€‚

å› ä¸ºæˆ‘ä»¬æœ‰ä¸¤ç§é¡¹ç›®åˆ†åˆ«æ˜¯**ç‰©æ–™**ä¸**ç”¨æˆ·**ï¼Œè¿™ä¸¤æ¬¾ç³»ç»Ÿä½œä¸ºåŸºç¡€åº”ç”¨ï¼ŒåæœŸä¹Ÿä¼šå¯¹å…¶ä»–çš„é¡¹ç›®æä¾›ç±»ä¼¼çš„ Open Apiï¼ŒåŒæ—¶é¿å…ä¸äº†å‡çº§ä¹‹åï¼Œéœ€è¦å…¼å®¹è€é¡¹ç›®çš„æƒ…å†µã€‚æ­¤æ—¶å°±ä¼šå­˜åœ¨å¤šç§ç‰ˆæœ¬çš„ Apiï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿåœ¨å·¥ç¨‹æ·»åŠ ç‰ˆæœ¬æ§åˆ¶æ¥é¿å…æœªæ¥å‡çº§çš„æ—¶å€™ï¼Œé€ æˆå…¶ä»–ç³»ç»Ÿå´©æºƒã€‚

#### å•ä¸ªè¯·æ±‚æ§åˆ¶

**ç¬¬ä¸€æ­¥**ï¼šåœ¨ `main.ts` å¯ç”¨ç‰ˆæœ¬é…ç½®ï¼š

```ts
import { VersioningType } from '@nestjs/common';
import { NestFactory } from '@nestjs/core';
import {
  FastifyAdapter,
  NestFastifyApplication,
} from '@nestjs/platform-fastify';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create<NestFastifyApplication>(
    AppModule,
    new FastifyAdapter(),
  );

  // æ¥å£ç‰ˆæœ¬åŒ–ç®¡ç†
  app.enableVersioning({
    type: VersioningType.URI,
  });

  await app.listen(3000);
}
bootstrap();

```

**ç¬¬äºŒæ­¥**ï¼šå¯ç”¨ç‰ˆæœ¬é…ç½®ä¹‹åå†åœ¨ `Controller` ä¸­è¯·æ±‚æ–¹æ³•æ·»åŠ å¯¹åº”çš„ç‰ˆæœ¬å·è£…é¥°å™¨ï¼š

```ts
import { Controller, Version } from '@nestjs/common';

  @Get()
  @Version('1')
  findAll() {
    return this.userService.findAll();
  }
```

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2015a74a73e04d32a9672c9a46e508c8~tplv-k3u1fbpfcp-watermark.image?)

é…ç½®å®Œæ¯•ä¹‹åä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œåªæœ‰æºå¸¦äº†ç‰ˆæœ¬å·çš„è¯·æ±‚ http://localhost:3000/v1/user èƒ½æ­£å¸¸è¿”å›æ•°æ®ï¼Œè€Œä¹‹å‰æœªæºå¸¦ç‰ˆæœ¬å·çš„è¯·æ±‚ http://localhost:3000/user è¿”å›äº† 404 é”™è¯¯ã€‚

é™¤äº†é’ˆå¯¹æŸä¸€ä¸ªè¯·æ±‚æ·»åŠ ç‰ˆæœ¬ä¹‹å¤–ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥æ·»åŠ å…¨å±€ä»¥åŠæ•´ä¸ª `Controller` çš„ç‰ˆæœ¬ï¼Œå…·ä½“çš„ç‰ˆæœ¬é…ç½®è§„åˆ™å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…éœ€æ±‚å–èˆã€‚


#### å…¨å±€é…ç½®è¯·æ±‚æ§åˆ¶

**ç¬¬ä¸€æ­¥**ï¼šä¿®æ”¹ `enableVersioning` é…ç½®é¡¹ï¼š
```diff
app.enableVersioning({
+   defaultVersion: '1',
    type: VersioningType.URI,
});
```

**ç¬¬äºŒæ­¥**ï¼šä¿®æ”¹ `Controller` çš„é…ç½®ï¼Œåœ¨ `Controller` è£…é¥°å™¨ä¸­æ·»åŠ  `version` å±æ€§ï¼š

```diff
- @Get()
- @Version('1')
+ @Controller({
+  path: 'user',
+  version: '1',
+ })
```

å®Œæˆä¸Šè¿°çš„æ“ä½œå°±å¯ä»¥å¯¹ä¸€æ•´ä¸ª `Controller` è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ã€‚ä½†æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åšé’ˆå¯¹ä¸€äº›æ¥å£åšå…¼å®¹æ€§çš„æ›´æ–°ï¼Œè€Œå…¶ä»–çš„è¯·æ±‚æ˜¯ä¸éœ€è¦æºå¸¦ç‰ˆæœ¬ï¼Œåˆæˆ–è€…è¯·æ±‚æœ‰å¤šä¸ªç‰ˆæœ¬çš„æ—¶å€™ï¼Œè€Œé»˜è®¤è¯·æ±‚æƒ³æŒ‡å®šä¸€ä¸ªç‰ˆæœ¬çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `enableVersioning` æ·»åŠ  `defaultVersion` å‚æ•°è¾¾åˆ°ä¸Šè¿°çš„è¦æ±‚ï¼š

```diff
+ import { VersioningType, VERSION_NEUTRAL } from '@nestjs/common';
  app.enableVersioning({
-    defaultVersion: '1',
+    defaultVersion: [VERSION_NEUTRAL, '1', '2']
  });
```

```ts
  @Get()
  @Version([VERSION_NEUTRAL, '1'])
  findAll() {
    return this.userService.findAll();
  }

  @Get()
  @Version('2')
  findAll2() {
    return 'i am new one';
  }
```

æ¥ä¸‹æ¥åˆ†åˆ«è®¿é—®å¯¹åº”çš„è¯·æ±‚http://localhost:3000/user ä¸ http://localhost:3000/v2/user å¯ä»¥è·å–åˆ°å¦‚ä¸‹çš„è¿”å›å€¼ï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/38d458d6dedc49a7949b5cd0d84def5b~tplv-k3u1fbpfcp-watermark.image?)

## å…¨å±€è¿”å›å‚æ•°

åœ¨é…ç½®ç‰ˆæœ¬çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¸æ–­åœ°æµ‹è¯•äº†å¾ˆå¤šæ¬¡æ¥å£ï¼Œä¸éš¾å‘ç°è¿”å›çš„æ¥å£æ•°æ®éå¸¸çš„ä¸æ ‡å‡†ï¼Œåœ¨ä¸€ä¸ªæ­£å¸¸çš„é¡¹ç›®ä¸­ä¸å¤ªåˆé€‚ç”¨è¿™ç§æ•°æ®ç»“æ„è¿”å›ï¼Œæ¯•ç«Ÿè¿™æ ·å¯¹å‰ç«¯ä¸å‹å¥½ï¼Œä¹Ÿä¸åˆ©äºå‰ç«¯åšç»Ÿä¸€çš„æ‹¦æˆªä¸å–å€¼ï¼Œæ‰€ä»¥éœ€è¦æ ¼å¼åŒ–è¯·æ±‚å‚æ•°ï¼Œè¾“å‡ºç»Ÿä¸€çš„æ¥å£è§„èŒƒã€‚

ä¸€èˆ¬æ­£å¸¸é¡¹ç›®çš„è¿”å›å‚æ•°åº”è¯¥åŒ…æ‹¬å¦‚ä¸‹çš„å†…å®¹ï¼š

```json
{
    data, // æ•°æ®
    status: 0, // æ¥å£çŠ¶æ€å€¼
    extra: {}, // æ‹“å±•ä¿¡æ¯
    message: 'success', // å¼‚å¸¸ä¿¡æ¯
    successï¼štrue // æ¥å£ä¸šåŠ¡è¿”å›çŠ¶æ€
}
```

æƒ³è¦è¾“å‡ºä¸Šè¿°æ ‡å‡†çš„è¿”å›å‚æ•°æ ¼å¼çš„è¯ï¼š

**ç¬¬ä¸€æ­¥**ï¼šæ–°å»º `src/common/interceptors/transform.interceptor.ts` æ–‡ä»¶ï¼š

```ts
import {
  Injectable,
  NestInterceptor,
  ExecutionContext,
  CallHandler,
} from '@nestjs/common';
import { Observable } from 'rxjs';
import { map } from 'rxjs/operators';

interface Response<T> {
  data: T;
}

@Injectable()
export class TransformInterceptor<T>
  implements NestInterceptor<T, Response<T>>
{
  intercept(
    context: ExecutionContext,
    next: CallHandler,
  ): Observable<Response<T>> {
    return next.handle().pipe(
      map((data) => ({
        data,
        status: 0,
        extra: {},
        message: 'success',
        success: true,
      })),
    );
  }
}
```

**ç¬¬äºŒæ­¥**ï¼šä¿®æ”¹ `main.ts` æ–‡ä»¶ï¼Œæ·»åŠ  `useGlobalInterceptors` å…¨å±€æ‹¦æˆªå™¨ï¼Œå¤„ç†è¿”å›å€¼

```diff
+ import { TransformInterceptor } from './common/interceptors/transform.interceptor';
// ç»Ÿä¸€å“åº”ä½“æ ¼å¼
+ app.useGlobalInterceptors(new TransformInterceptor());
```

ç„¶åæˆ‘ä»¬å†æ¬¡è®¿é—®ä¹‹å‰çš„è¯·æ±‚ï¼Œå°±èƒ½è·å–åˆ°æ ‡å‡†æ ¼å¼çš„æ¥å£è¿”å›å€¼äº†ï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/826099eac0d4471b922d919d64e6040e~tplv-k3u1fbpfcp-watermark.image?)

## å…¨å±€å¼‚å¸¸æ‹¦æˆª

å¤„ç†å®Œæ­£å¸¸çš„è¿”å›å‚æ•°æ ¼å¼ä¹‹åï¼Œå¯¹äºå¼‚å¸¸å¤„ç†ä¹Ÿåº”è¯¥åšä¸€å±‚æ ‡å‡†çš„å°è£…ï¼Œè¿™æ ·åˆ©äºå¼€å‘å‰ç«¯çš„åŒå­¦ç»Ÿä¸€å¤„ç†è¿™ç±»å¼‚å¸¸é”™è¯¯ã€‚

**ç¬¬ä¸€æ­¥**ï¼šæ–°å»º `src/common/exceptions/base.exception.filter.ts` ä¸ `http.exception.filter.ts` ä¸¤ä¸ªæ–‡ä»¶ï¼Œä»å‘½åä¸­å¯ä»¥çœ‹å‡ºå®ƒä»¬åˆ†åˆ«å¤„ç†**ç»Ÿä¸€å¼‚å¸¸**ä¸ `HTTP` ç±»å‹çš„æ¥å£ç›¸å…³å¼‚å¸¸ã€‚

`base.exception.filter` => **`Catch` çš„å‚æ•°ä¸ºç©ºæ—¶ï¼Œé»˜è®¤æ•è·æ‰€æœ‰å¼‚å¸¸**
```ts
import { FastifyReply, FastifyRequest } from "fastify";

import {
  ExceptionFilter,
  Catch,
  ArgumentsHost,
  HttpStatus,
  ServiceUnavailableException,
  HttpException,
} from '@nestjs/common';

@Catch()
export class AllExceptionsFilter implements ExceptionFilter {
  catch(exception: Error, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<FastifyReply>();
    const request = ctx.getRequest<FastifyRequest>();

    request.log.error(exception)

    // é HTTP æ ‡å‡†å¼‚å¸¸çš„å¤„ç†ã€‚
    response.status(HttpStatus.SERVICE_UNAVAILABLE).send({
      statusCode: HttpStatus.SERVICE_UNAVAILABLE,
      timestamp: new Date().toISOString(),
      path: request.url,
      message: new ServiceUnavailableException().getResponse(),
    });
  }
}
```

`http.exception.filter.ts` => `Catch` çš„å‚æ•°ä¸º `HttpException` å°†åªæ•è· `HTTP` ç›¸å…³çš„å¼‚å¸¸é”™è¯¯

```ts
import { FastifyReply, FastifyRequest } from "fastify";
import {
  ExceptionFilter,
  Catch,
  ArgumentsHost,
  HttpException,
} from '@nestjs/common';

@Catch(HttpException)
export class HttpExceptionFilter implements ExceptionFilter {
  catch(exception: HttpException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<FastifyReply>();
    const request = ctx.getRequest<FastifyRequest>();
    const status = exception.getStatus();

    response.status(status).send({
      statusCode: status,
      timestamp: new Date().toISOString(),
      path: request.url,
      message: exception.getResponse(),
    });
  }
}
```

**ç¬¬äºŒæ­¥**ï¼šåœ¨ `main.ts` æ–‡ä»¶ä¸­æ·»åŠ  `useGlobalFilters` å…¨å±€è¿‡æ»¤å™¨ï¼š

```diff
+ import { AllExceptionsFilter } from './common/exceptions/base.exception.filter';
+ import { HttpExceptionFilter } from './common/exceptions/http.exception.filter';
  // å¼‚å¸¸è¿‡æ»¤å™¨
+ app.useGlobalFilters(new AllExceptionsFilter(), new HttpExceptionFilter());
```

> **è¿™é‡Œä¸€å®šè¦æ³¨æ„å¼•å…¥è‡ªå®šä¹‰å¼‚å¸¸çš„å…ˆåé¡ºåºï¼Œä¸ç„¶å¼‚å¸¸æ•è·é€»è¾‘ä¼šå‡ºç°æ··ä¹±**ã€‚

å®Œæˆä¸Šè¿°æ“ä½œä¹‹åå¼€å§‹æ£€éªŒæ˜¯å¦é…ç½®æ­£å¸¸ã€‚é¦–å…ˆè®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„æ¥å£ http://localhost:3000/test ï¼Œæ­¤æ—¶å¯ä»¥å¯¹æ¯”è‡ªå®šä¹‰ä¸åŸç”Ÿçš„å¼‚å¸¸è¿”å›å‚æ•°åŒºåˆ«ã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b0b8f5e7f9b24dcaacf33ab10d88f613~tplv-k3u1fbpfcp-watermark.image?)

éªŒè¯å®Œ `HTTP` å¼‚å¸¸ä¹‹åï¼Œæˆ‘ä»¬æ¥ç€åœ¨ `UserController` ä¸­ä¼ªé€ ä¸€ä¸ªç¨‹åºè¿è¡Œå¼‚å¸¸çš„æ¥å£ï¼Œæ¥éªŒè¯å¸¸è§„å¼‚å¸¸æ˜¯å¦èƒ½è¢«æ­£å¸¸æ•è·ï¼š

```
  @Get('findError')
  @Version([VERSION_NEUTRAL, '1'])
  findError() {
    const a: any = {}
    console.log(a.b.c)
    return this.userService.findAll();
  }
```

å†æ¬¡è®¿é—® http://localhost:3000/user/findError ï¼Œæ­¤æ—¶å¯ä»¥çœ‹åˆ°åŸç”Ÿä¸è‡ªå®šä¹‰è¿”å›çš„å¼‚å¸¸é”™è¯¯å­˜åœ¨ä¸€å®šçš„åŒºåˆ«äº†ã€‚

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/23892fd1a32e4e4cba805df4e3bf7892~tplv-k3u1fbpfcp-watermark.image?)

é™¤äº†å…¨å±€å¼‚å¸¸æ‹¦æˆªå¤„ç†ä¹‹å¤–ï¼Œæˆ‘ä»¬éœ€è¦å†æ–°å»ºä¸€ä¸ª `business.exception.ts` æ¥å¤„ç†ä¸šåŠ¡è¿è¡Œä¸­é¢„çŸ¥ä¸”ä¸»åŠ¨æŠ›å‡ºçš„å¼‚å¸¸ï¼š

```ts
import { HttpException, HttpStatus } from '@nestjs/common';
import { BUSINESS_ERROR_CODE } from './business.error.codes';

type BusinessError = {
  code: number;
  message: string;
};

export class BusinessException extends HttpException {
  constructor(err: BusinessError | string) {
    if (typeof err === 'string') {
      err = {
        code: BUSINESS_ERROR_CODE.COMMON,
        message: err,
      };
    }
    super(err, HttpStatus.OK);
  }

  static throwForbidden() {
    throw new BusinessException({
      code: BUSINESS_ERROR_CODE.ACCESS_FORBIDDEN,
      message: 'æŠ±æ­‰å“¦ï¼Œæ‚¨æ— æ­¤æƒé™ï¼',
    });
  }
}
```

```ts
export const BUSINESS_ERROR_CODE = {
  // å…¬å…±é”™è¯¯ç 
  COMMON: 10001,
  // ç‰¹æ®Šé”™è¯¯ç 
  TOKEN_INVALID: 10002,
  // ç¦æ­¢è®¿é—®
  ACCESS_FORBIDDEN: 10003,
  // æƒé™å·²ç¦ç”¨
  PERMISSION_DISABLED: 10003,
  // ç”¨æˆ·å·²å†»ç»“
  USER_DISABLED: 10004,
};

```

ç®€å•æ”¹é€ ä¸€ä¸‹ `HttpExceptionFilter`ï¼Œåœ¨å¤„ç† `HTTP` å¼‚å¸¸è¿”å›ä¹‹å‰å…ˆå¤„ç†ä¸šåŠ¡å¼‚å¸¸ï¼š

```ts
import { FastifyReply, FastifyRequest } from "fastify";
import {
  ExceptionFilter,
  Catch,
  ArgumentsHost,
  HttpException,
  HttpStatus,
} from '@nestjs/common';
import { BusinessException } from "./business.exception";

@Catch(HttpException)
export class HttpExceptionFilter implements ExceptionFilter {
  catch(exception: HttpException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<FastifyReply>();
    const request = ctx.getRequest<FastifyRequest>();
    const status = exception.getStatus();

    // å¤„ç†ä¸šåŠ¡å¼‚å¸¸
    if (exception instanceof BusinessException) {
      const error = exception.getResponse();
      response.status(HttpStatus.OK).send({
        data: null,
        status: error['code'],
        extra: {},
        message: error['message'],
        success: false,
      });
      return;
    }

    response.status(status).send({
      statusCode: status,
      timestamp: new Date().toISOString(),
      path: request.url,
      message: exception.getResponse(),
    });
  }
}
```

> ç”±äºå¼‚å¸¸æ‹¦æˆªçš„è¿”å›å‡½æ•°ä½¿ç”¨çš„æ˜¯ `Fastify` æä¾›çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨çš„è¿”å›æ–¹æ³•æ˜¯ `.sendï¼ˆï¼‰`ï¼Œå¦‚æœä½ æ²¡æœ‰ä½¿ç”¨ `Fastify` ä½œä¸º `HTTP` åº•å±‚æœåŠ¡çš„è¯ï¼Œæ‹¦æˆªè¿”å›çš„æ–¹æ³•è¦ä¿æŒè·Ÿå®˜ç½‘ä¸€è‡´ï¼ˆå®˜ç½‘é»˜è®¤çš„æ˜¯ `Express` çš„æ¡†æ¶ï¼Œæ‰€ä»¥è¿”å›æ–¹æ³•ä¸ä¸€æ ·ï¼‰ã€‚ 

å®Œæˆé…ç½®ä¹‹åï¼Œæˆ‘ä»¬ç»§ç»­åœ¨ `UserController` ä¸­é‡æ–°ä¼ªé€ ä¸€ä¸ªä¸šåŠ¡å¼‚å¸¸çš„åœºæ™¯ï¼š

```diff
+ import { BusinessException } from 'src/common/exceptions/business.exception';

  @Get('findBusinessError')
  @Version([VERSION_NEUTRAL, '1'])
  findBusinessError() {
    const a: any = {}
    try {
      console.log(a.b.c)
    } catch (error) {
      throw new BusinessException('ä½ è¿™ä¸ªå‚æ•°é”™äº†')
    }
    return this.userService.findAll();
  }
```

è®¿é—®æ¥å£ http://localhost:3000/user/findBusinessError ï¼Œå¯ä»¥çœ‹åˆ°èƒ½å¤Ÿè¿”å›æˆ‘ä»¬é¢„æœŸçš„é”™è¯¯äº†ã€‚

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/44e2d881639342428a05875258e7dba3~tplv-k3u1fbpfcp-watermark.image?)

> è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸çš„ä¼˜ç‚¹åœ¨äºï¼Œå½“ä½ çš„ä¸šåŠ¡é€»è¾‘å¤æ‚åˆ°ä¸€å®šçš„åœ°æ­¥ï¼Œåœ¨ä»»æ„çš„ä¸€å¤„å‡ºç°å¯é¢„çŸ¥çš„é”™è¯¯ï¼Œæ­¤æ—¶å¯ä»¥ç›´æ¥æŠ›å‡ºå¼‚å¸¸è®©ç”¨æˆ·æ„ŸçŸ¥ï¼Œä¸éœ€è¦å†™å¾ˆå¤šå†—ä½™çš„è¿”å›ä»£ç ã€‚

å¼‚å¸¸æ‹¦æˆªã€å…¨å±€è¿”å›å‚æ•°ä¿®æ”¹ä»¥åŠæ›¿æ¢ `Fastify` æ¡†æ¶çš„ä»£ç å·²ä¸Šä¼  [demo/v2](https://github.com/boty-design/gateway/tree/demo/v2)ï¼Œ éœ€è¦çš„åŒå­¦å¯ä»¥è‡ªå–ã€‚

## ç¯å¢ƒé…ç½®

ä¸€èˆ¬åœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œè‡³å°‘ä¼šç»å†è¿‡ `Dev` -> `Test` -> `Prod` ä¸‰ä¸ªç¯å¢ƒã€‚å¦‚æœå†å¯Œä½™ä¸€ç‚¹çš„è¯ï¼Œè¿˜ä¼šå†å¤šä¸€ä¸ª `Pre` ç¯å¢ƒã€‚ç”šè‡³åœ¨ä¸å·®é’±çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªç¯å¢ƒå¯èƒ½éƒ½ä¼šæœ‰**å¤šå¥—é…ç½®**ã€‚é‚£ä¹ˆå¯¹åº”çš„ä½¿ç”¨çš„æ•°æ®åº“ã€`Redis` æˆ–è€…å…¶ä»–çš„é…ç½®é¡¹éƒ½ä¼šéšç€ç¯å¢ƒçš„å˜æ¢è€Œæ”¹å˜ï¼Œæ‰€ä»¥åœ¨å®é™…é¡¹ç›®å¼€å‘ä¸­ï¼Œå¤šç¯å¢ƒçš„é…ç½®éå¸¸å¿…è¦ã€‚

#### è‡ªå¸¦ç¯å¢ƒé…ç½®

`NestJS` æœ¬èº«ä¹Ÿè‡ªå¸¦äº†å¤šç¯å¢ƒé…ç½®æ–¹æ³•

1. å®‰è£… `@nestjs/config`

```
$ yarn add  @nestjs/config
```

2. å®‰è£…å®Œæ¯•ä¹‹åï¼Œåœ¨ `app.module.ts` ä¸­æ·»åŠ  `ConfigModule` æ¨¡å—

```ts
import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { UserModule } from './user/user.module';
import { ConfigModule } from '@nestjs/config';

@Module({
  imports: [ConfigModule.forRoot(), UserModule],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule { }
```

`@nestjs/config` é»˜è®¤ä¼šä»**é¡¹ç›®æ ¹ç›®å½•**è½½å…¥å¹¶è§£æä¸€ä¸ª `.env` æ–‡ä»¶ï¼Œä» `.env` æ–‡ä»¶å’Œ `process.env` åˆå¹¶ç¯å¢ƒå˜é‡é”®å€¼å¯¹ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åˆ°ä¸€ä¸ªå¯ä»¥é€šè¿‡ `ConfigService` è®¿é—®çš„ç§æœ‰ç»“æ„ã€‚

`forRoot()` æ–¹æ³•æ³¨å†Œäº† `ConfigService` æä¾›è€…ï¼Œåè€…æä¾›äº†ä¸€ä¸ª `get()` æ–¹æ³•æ¥è¯»å–è¿™äº›**è§£æ/åˆå¹¶**çš„é…ç½®å˜é‡ã€‚

> å½“ä¸€ä¸ªé”®åŒæ—¶ä½œä¸ºç¯å¢ƒå˜é‡ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡æ“ä½œç³»ç»Ÿç»ˆç«¯å¦‚`export DATABASE_USER=test`å¯¼å‡ºï¼‰å­˜åœ¨äºè¿è¡Œç¯å¢ƒä¸­ä»¥åŠ`.env`æ–‡ä»¶ä¸­æ—¶ï¼Œä»¥è¿è¡Œç¯å¢ƒå˜é‡ä¼˜å…ˆã€‚

é»˜è®¤çš„ `.env` æ–‡ä»¶å˜é‡å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼Œé…ç½®åä¼šé»˜è®¤è¯»å–æ­¤æ–‡ä»¶:

```
DATABASE_USER=test
DATABASE_PASSWORD=test
```

#### è‡ªå®šä¹‰ YAML

è™½ç„¶ `Nest` è‡ªå¸¦äº†ç¯å¢ƒé…ç½®çš„åŠŸèƒ½ï¼Œä½¿ç”¨çš„ [dotenv](https://github.com/motdotla/dotenv) æ¥ä½œä¸ºé»˜è®¤è§£æï¼Œä½†é»˜è®¤é…ç½®é¡¹çœ‹èµ·æ¥å¹¶ä¸æ˜¯éå¸¸æ¸…çˆ½ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä½¿ç”¨ç»“æ„æ›´åŠ æ¸…æ™°çš„ `YAML` æ¥è¦†ç›–é»˜è®¤é…ç½®ã€‚

> æƒ³è¦äº†è§£ `YAML` æ›´å¤šç»†èŠ‚çš„åŒå­¦å¯ä»¥ç‚¹å‡»[é“¾æ¥](https://baike.baidu.com/item/YAML/1067697)çœ‹ä¸‹ï¼Œå¦‚æœä½¿ç”¨è¿‡ `GitLab CICD` çš„åŒå­¦ï¼Œåº”è¯¥å¯¹ `.yml` æ–‡ä»¶æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œè¿™é‡Œæˆ‘å°±ä¸å¯¹ `YAML` é…ç½®æ–‡ä»¶åšè¿‡å¤šé˜è¿°äº†ã€‚

1. åœ¨ä½¿ç”¨è‡ªå®šä¹‰ `YAML` é…ç½®æ–‡ä»¶ä¹‹å‰ï¼Œå…ˆè¦ä¿®æ”¹ `app.module.ts` ä¸­ `ConfigModule` çš„é…ç½®é¡¹ `ignoreEnvFile`ï¼Œç¦ç”¨é»˜è®¤è¯»å– `.env` çš„è§„åˆ™ï¼š

```
ConfigModule.forRoot({ ignoreEnvFile: true, });
```

2. ç„¶åå†å®‰è£… `YAML` çš„ `Node` åº“ `yaml`ï¼š

```
$ yarn add yaml
```

3. å®‰è£…å®Œæ¯•ä¹‹åï¼Œåœ¨æ ¹ç›®å½•æ–°å»º `.config` æ–‡ä»¶å¤¹ï¼Œå¹¶åˆ›å»ºå¯¹åº”ç¯å¢ƒçš„ `yaml` æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/71e2c740648641b499440a0bd0038e31~tplv-k3u1fbpfcp-watermark.image?)

4. æ–°å»º `utils/index.ts` æ–‡ä»¶ï¼Œæ·»åŠ è¯»å– `YAML` é…ç½®æ–‡ä»¶çš„æ–¹æ³•ï¼š

```ts
import { parse } from 'yaml'
const path = require('path');
const fs = require('fs');

// è·å–é¡¹ç›®è¿è¡Œç¯å¢ƒ
export const getEnv = () => {
  return process.env.RUNNING_ENV
}

// è¯»å–é¡¹ç›®é…ç½®
export const getConfig = () => {
  const environment = getEnv()
  const yamlPath = path.join(process.cwd(), `./.config/.${environment}.yaml`)
  const file = fs.readFileSync(yamlPath, 'utf8')
  const config = parse(file)
  return config
}
```

5. æœ€åæ·»åŠ åœ¨ `app.module.ts` è‡ªå®šä¹‰é…ç½®é¡¹å³å¯æ­£å¸¸ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼š

```diff
+ import { getConfig } from './utils';
    ConfigModule.forRoot({
      ignoreEnvFile: true,
+     isGlobal: true,
+     load: [getConfig]
    }),
```

> æ³¨æ„ï¼š`load` æ–¹æ³•ä¸­ä¼ å…¥çš„ `getConfig` æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸æ˜¯ç›´æ¥ JSON æ ¼å¼çš„é…ç½®å¯¹è±¡ï¼Œç›´æ¥æ·»åŠ å˜é‡ä¼šæŠ¥é”™ã€‚

#### ä½¿ç”¨è‡ªå®šä¹‰é…ç½®

å®Œæˆä¹‹å‰çš„é…ç½®åï¼Œå°±å¯ä»¥ä½¿ç”¨ `cross-env` æŒ‡å®šè¿è¡Œç¯å¢ƒæ¥ä½¿ç”¨å¯¹åº”ç¯å¢ƒçš„é…ç½®å˜é‡ã€‚

1. æ·»åŠ  cross-env ä¾èµ–ï¼š

```shell
$ yarn add cross-env
```

2. ä¿®æ”¹å¯åŠ¨å‘½ä»¤ï¼š

```
"start:dev": "cross-env RUNNING_ENV=dev nest start --watch",
```

3. æ·»åŠ  .dev.yaml é…ç½®:

```
TEST_VALUE:
  name: cookie
```

> æ³¨æ„ `yaml` é…ç½®çš„è§„åˆ™ï¼Œç¼©è¿›ä»¥åŠå†’å· **:** åçš„ç©ºæ ¼æ˜¯ç»å¸¸å®¹æ˜“å‡ºé”™çš„åœ°æ–¹

4. åœ¨æˆ‘ä»¬ä¹‹å‰åˆ›å»ºå¥½çš„ `UserController` ä¸­æ·»åŠ  `ConfigService` ä»¥åŠæ–°çš„è¯·æ±‚ï¼š

```ts

export class UserController {
  constructor(
    private readonly userService: UserService,
    private readonly configService: ConfigService
  ) { }

  @Get('getTestName')
  getTestName() {
    return this.configService.get('TEST_VALUE').name;
  }
}
```
å®Œæˆä¸Šè¿°æ‰€æœ‰æ­¥éª¤ä¹‹åï¼Œé‡å¯é¡¹ç›®ï¼Œæ¥ä¸‹æ¥è®¿é—® http://localhost:3000/v1/user/getTestName èƒ½çœ‹åˆ°å·²ç»èƒ½å¤Ÿæ ¹æ®ç¯å¢ƒå˜é‡æ‹¿åˆ°å¯¹åº”çš„å€¼ï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fc2fc65526944018b70040715cbcb340~tplv-k3u1fbpfcp-watermark.image?)

> è¿™é‡Œåº”è¯¥æ³¨æ„åˆ°ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰æ³¨å†Œ `ConfigModule`ã€‚è¿™æ˜¯å› ä¸ºåœ¨ `app.module` ä¸­æ·»åŠ  `isGlobal` å±æ€§ï¼Œå¼€å¯ `Config` å…¨å±€æ³¨å†Œï¼Œå¦‚æœ `isGlobal` æ²¡æœ‰æ·»åŠ çš„è¯ï¼Œåˆ™éœ€è¦å…ˆåœ¨å¯¹åº”çš„ `module` æ–‡ä»¶ä¸­æ³¨å†Œåæ‰èƒ½æ­£å¸¸ä½¿ç”¨ `ConfigService`ã€‚

> é¡¹ç›®é…ç½®çš„ç›¸å…³ä»£ç å·²ä¸Šä¼  [demo/v3](https://github.com/boty-design/gateway/tree/demo/v3) åˆ†æ”¯ä¸­ï¼Œéœ€è¦çš„åŒå­¦è‡ªå–ã€‚ç”±äº `.config` é‡Œé¢çš„é…ç½®ä¿¡æ¯æ¯”è¾ƒéšç§ï¼Œæ‰€ä»¥ä¸ä¼šä¸Šä¼ åˆ° `git` å½“ä¸­ï¼Œéœ€è¦çš„åŒå­¦å¯ä»¥åœ¨[ç¬¬ä¹ç« èŠ‚-å­¦ä¹ é‡Œç¨‹ç¢‘](https://juejin.cn/book/7065201654273933316/section/7111992826132430859)ä¸­è·å–å¯¹åº”çš„æ¨¡æ¿ã€‚

## çƒ­é‡è½½

`NestJS` çš„ `dev` æ¨¡å¼æ˜¯å°† `TS` ä»£ç ç¼–è¯‘æˆ `JS` å†å¯åŠ¨ï¼Œè¿™æ ·æ¯æ¬¡æˆ‘ä»¬ä¿®æ”¹ä»£ç éƒ½ä¼šé‡å¤ç»å†ä¸€æ¬¡ç¼–è¯‘çš„è¿‡ç¨‹ã€‚åœ¨é¡¹ç›®å¼€å‘åˆæœŸï¼Œä¸šåŠ¡æ¨¡å—ä½“é‡ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œæ€§èƒ½å¼€é”€å¹¶ä¸ä¼šæœ‰å¾ˆå¤§çš„å½±å“ï¼Œä½†æ˜¯åœ¨ä¸šåŠ¡æ¨¡å—å¢åŠ åˆ°ä¸€å®šæ•°é‡æ—¶ï¼Œæ¯ä¸€æ¬¡æ›´æ–°ä»£ç å¯¼è‡´çš„é‡æ–°ç¼–è¯‘å°±ä¼šå¼‚å¸¸ç—›è‹¦ã€‚ä¸ºäº†é¿å…è¿™ä¸ªæƒ…å†µï¼Œ`NestJS` ä¹Ÿæä¾›äº†çƒ­é‡è½½çš„åŠŸèƒ½ï¼Œå€ŸåŠ© `Webpack` çš„ `HMR`ï¼Œä½¿å¾—æ¯æ¬¡æ›´æ–°åªéœ€è¦æ›¿æ¢æ›´æ–°çš„å†…å®¹ï¼Œå‡å°‘ç¼–è¯‘çš„æ—¶é—´ä¸è¿‡ç¨‹ã€‚

> æ³¨æ„ï¼š`Webpack`å¹¶ä¸ä¼šè‡ªåŠ¨å°†ï¼ˆä¾‹å¦‚ `graphql` æ–‡ä»¶ï¼‰å¤åˆ¶åˆ° `dist` æ–‡ä»¶å¤¹ä¸­ã€‚åŒç†ï¼Œ`Webpack` ä¸é™æ€è·¯å¾„ï¼ˆä¾‹å¦‚ `TypeOrmModule` ä¸­çš„ `entities` å±æ€§ï¼‰ä¸å…¼å®¹ã€‚æ‰€ä»¥å¦‚æœæœ‰åŒå­¦è·³è¿‡æœ¬ç« ï¼Œç›´æ¥é…ç½®äº† `TypeOrmModule` ä¸­çš„ `entities`ï¼Œåè¿‡æ¥å†ç›´æ¥é…ç½®çƒ­é‡è½½ä¼šå¯¼è‡´å¯åŠ¨å¤±è´¥ã€‚

ç”±äºæˆ‘ä»¬æ˜¯ä½¿ç”¨ `CLI` æ’ä»¶å®‰è£…çš„å·¥ç¨‹æ¨¡æ¿ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ `HotModuleReplacementPlugin` åˆ›å»ºé…ç½®ï¼Œå‡å°‘å·¥ä½œé‡ã€‚

1. ç…§ä¾‹å®‰è£…æ‰€éœ€ä¾èµ–ï¼š

```
$ yarn add webpack-node-externals run-script-webpack-plugin webpack
```

2. æ ¹ç›®å½•æ–°å»º `webpack-hmr.config.js` æ–‡ä»¶ï¼Œå¤åˆ¶ä¸‹è¿°ä»£ç ï¼š

```js
const nodeExternals = require('webpack-node-externals');
const { RunScriptWebpackPlugin } = require('run-script-webpack-plugin');

module.exports = function (options, webpack) {
  return {
    ...options,
    entry: ['webpack/hot/poll?100', options.entry],
    externals: [
      nodeExternals({
        allowlist: ['webpack/hot/poll?100'],
      }),
    ],
    plugins: [
      ...options.plugins,
      new webpack.HotModuleReplacementPlugin(),
      new webpack.WatchIgnorePlugin({
        paths: [/.js$/, /.d.ts$/],
      }),
      new RunScriptWebpackPlugin({ name: options.output.filename }),
    ],
  };
};
```

3. ä¿®æ”¹ `main.ts`ï¼Œå¼€å¯ `HMR` åŠŸèƒ½ï¼š

```ts
declare const module: any;

async function bootstrap() {
  if (module.hot) {
    module.hot.accept();
    module.hot.dispose(() => app.close());
  }
}
bootstrap();
```

4. ä¿®æ”¹å¯åŠ¨è„šæœ¬å¯åŠ¨å‘½ä»¤å³å¯ï¼š

```
"start:hotdev": "cross-env RUNNING_ENV=dev nest build --webpack --webpackPath webpack-hmr.config.js --watch"
```

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d7b960fe772e404cbac3276e5e167db9~tplv-k3u1fbpfcp-watermark.image?)

ç„¶åä¿®æ”¹ä¸€æ®µç®€å•çš„ä»£ç ï¼ˆéšæ„ä¿®æ”¹å³å¯ï¼‰ï¼Œæµ‹è¯•ä¸€ä¸‹çƒ­æ›´æ–°çš„æ˜¯å¦æ­£å¸¸ç”Ÿæ•ˆï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/659b2d68c1d145d1b3a7f5bfff96ee98~tplv-k3u1fbpfcp-watermark.image?)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å·²ç»å¼€å¯äº† `HMR` åŠŸèƒ½ï¼Œå…·ä½“ä»€ä¹ˆæ—¶å€™ä½¿ç”¨å¯ä»¥æ ¹æ®è‡ªå·±çš„é¡¹ç›®ä»¥åŠå–œå¥½å¼€å¯ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨ `CLI` åˆ›å»ºçš„å·¥ç¨‹æ¨¡æ¿ï¼Œä½†ä¹Ÿæƒ³å¼€å¯ `HMR` åŠŸèƒ½çš„è¯ï¼Œå¯ä»¥æ ¹æ®[æ–‡æ¡£](https://docs.nestjs.cn/8/recipes?id=%e6%b2%a1%e6%9c%89%e4%bd%bf%e7%94%a8-cli) è‡ªè¡Œé…ç½®ã€‚

> çƒ­æ›´æ–°çš„åŠŸèƒ½çœ‹è‡ªå·±çš„éœ€æ±‚å†å¼€å¯ï¼Œæœ‰çš„æ—¶å€™å­˜åœ¨ç¼“å­˜çš„æƒ…å†µå‡ºç°ï¼Œ**å¦å¤–ï¼Œåœ¨ä½¿ç”¨çƒ­æ›´æ–°çš„æ—¶å€™ï¼Œæ•°æ®åº“ç« èŠ‚ä¸­å®ä½“ç±»éœ€è¦æ‰‹åŠ¨æ³¨å†Œï¼Œä¸èƒ½è‡ªåŠ¨æ³¨å†Œ**ï¼Œæ‰€ä»¥å¦‚æœé¡¹ç›®ä¸å¤§çš„å•¥æƒ…å†µï¼Œä½¿ç”¨ **NestJS** è‡ªå¸¦çš„é¡¹ç›®å¯åŠ¨è„šæœ¬å³å¯ã€‚

## æ–‡æ¡£

ä½œä¸ºä¸€ä¸ªåç«¯æœåŠ¡ï¼Œ**API** æ–‡æ¡£æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œé™¤äº†æ¥å£æè¿°ã€å‚æ•°æè¿°ä¹‹å¤–ï¼Œè‡ªæµ‹ä¹Ÿååˆ†æ–¹ä¾¿ã€‚`NestJS` è‡ªå¸¦äº† `Swagger` æ–‡æ¡£ï¼Œé›†æˆéå¸¸ç®€å•ï¼Œæ¥ä¸‹æ¥è¿›è¡Œæ–‡æ¡£çš„é…ç½®éƒ¨åˆ†ã€‚

1. å·¥ç¨‹ä¹‹å‰ä½¿ç”¨äº† `fastify` æ‰€ä»¥éœ€è¦å®‰è£…ä»¥ä¸‹ä¾èµ–ï¼š

```
$ yarn add @nestjs/swagger 
```

> æ–°ç‰ˆæœ¬å·²ç»ä¸éœ€è¦å®‰è£… fastify-swagger ä¾èµ–ï¼Œé»˜è®¤è¢«å†…ç½®åœ¨ `@nestjs/swagger` ä¸­äº†ã€‚

2. ä¾èµ–å®‰è£…å®Œæ¯•ä¹‹åï¼Œå…ˆåˆ›å»º `src/doc.ts` æ–‡ä»¶ï¼š

```ts
import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';
import * as packageConfig from '../package.json'

export const generateDocument = (app) => {

  const options = new DocumentBuilder()
    .setTitle(packageConfig.name)
    .setDescription(packageConfig.description)
    .setVersion(packageConfig.version)
    .build();

  const document = SwaggerModule.createDocument(app, options);

  SwaggerModule.setup('/api/doc', app, document);
}
```

> ä¸ºäº†èŠ‚çº¦é…ç½®é¡¹ï¼Œ`Swagger` çš„é…ç½®ä¿¡æ¯å…¨éƒ¨å–è‡ª `package.json`ï¼Œæœ‰é¢å¤–éœ€æ±‚çš„è¯å¯ä»¥è‡ªå·±ç»´æŠ¤é…ç½®ä¿¡æ¯çš„æ–‡ä»¶ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨ `TS` å¼€å‘çš„é¡¹ç›®ä¸­æ˜¯æ²¡åŠæ³•å¯¼å…¥ `.json` åç¼€çš„æ¨¡å—ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ `tsconfig.json` ä¸­æ–°å¢ `resolveJsonModule` é…ç½®å³å¯ã€‚

```diff
{
  "compilerOptions": {
    "module": "commonjs",
    "declaration": true,
    "removeComments": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "allowSyntheticDefaultImports": true,
    "target": "es2017",
    "sourceMap": true,
    "outDir": "./dist",
    "baseUrl": "./",
    "incremental": true,
    "skipLibCheck": true,
    "strictNullChecks": false,
    "noImplicitAny": false,
    "strictBindCallApply": false,
    "forceConsistentCasingInFileNames": false,
    "noFallthroughCasesInSwitch": false,
+   "resolveJsonModule": true
  }
}
```

4. åœ¨ `main.ts` ä¸­å¼•å…¥æ–¹æ³•å³å¯ï¼š

```diff
import { VersioningType, VERSION_NEUTRAL } from '@nestjs/common';
import { NestFactory } from '@nestjs/core';
import {
  FastifyAdapter,
  NestFastifyApplication,
} from '@nestjs/platform-fastify';
import { AppModule } from './app.module';
import { AllExceptionsFilter } from './common/exceptions/base.exception.filter';
import { HttpExceptionFilter } from './common/exceptions/http.exception.filter';
import { TransformInterceptor } from './common/interceptors/transform.interceptor';
+ import { generateDocument } from './doc';

declare const module: any;

async function bootstrap() {
  const app = await NestFactory.create<NestFastifyApplication>(
    AppModule,
    new FastifyAdapter(),
  );

  // ç»Ÿä¸€å“åº”ä½“æ ¼å¼
  app.useGlobalInterceptors(new TransformInterceptor());

  // å¼‚å¸¸è¿‡æ»¤å™¨
  app.useGlobalFilters(new AllExceptionsFilter(), new HttpExceptionFilter());

  // æ¥å£ç‰ˆæœ¬åŒ–ç®¡ç†
  app.enableVersioning({
    defaultVersion: [VERSION_NEUTRAL, '1', '2'],
    type: VersioningType.URI,
  });

+  // åˆ›å»ºæ–‡æ¡£
+  generateDocument(app)

  // æ·»åŠ çƒ­æ›´æ–°
  if (module.hot) {
    module.hot.accept();
    module.hot.dispose(() => app.close());
  }

  await app.listen(3000);
}
bootstrap();
```
å®Œæˆä¸Šè¿°å†…å®¹ä¹‹åï¼Œæµè§ˆå™¨æ‰“å¼€ http://localhost:3000/api/doc å°±èƒ½çœ‹åˆ° `Swagger` å·²ç»å°†æˆ‘ä»¬çš„å‰é¢å†™å¥½çš„æ¥å£ä¿¡æ¯æ”¶é›†èµ·æ¥äº†ã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/777e652772fe47ce8ea0ac87dd17812e~tplv-k3u1fbpfcp-watermark.image?)

> ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œ`Swagger` ä¼šé»˜è®¤æ”¶é›†æˆ‘ä»¬çš„æ¥å£ä¿¡æ¯ï¼Œä½†æ˜¯æ²¡æœ‰æè¿°ä¸åˆ†ç±»ï¼Œä½¿ç”¨ä¸Šå¾ˆä¸æ–¹ä¾¿ï¼Œç”±äºä½¿ç”¨è¿‡ç¨‹ä¸­çš„ç»†èŠ‚è¾ƒå¤šï¼Œå…·ä½“çš„é…ç½®ç»†èŠ‚å¯ä»¥ä»[å®˜ç½‘æ–‡æ¡£](https://docs.nestjs.cn/8/recipes?id=swagger)è·å–ã€‚

> çƒ­æ›´æ–°ä¸ `Swagger` æ–‡æ¡£é…ç½®ä»£ç ä»¥ä¸Šä¼  [demo/v4](https://github.com/boty-design/gateway/tree/demo/v4)ï¼Œéœ€è¦çš„åŒå­¦å¯ä»¥è‡ªå–ã€‚

## å†™åœ¨æœ€å

æœ¬ç« ä¸»è¦ä»‹ç»äº†ï¼Œå¯¹ `CLI` åˆ›å»ºçš„æ ‡å‡†å·¥ç¨‹æ¨¡æ¿è¿›è¡Œä¸€äº›å¸¸è§„é¡¹ç›®å¿…å¤‡çš„åŠŸèƒ½é…ç½®ï¼Œä¾‹å¦‚æ›¿æ¢åº•å±‚ `HTTP` æ¡†æ¶ã€ç¯å¢ƒå˜é‡é…ç½®ç­‰ç­‰å†…å®¹ã€‚

æ·»åŠ äº†ä¸Šè¿°**é€šç”¨æ€§åŸºç¡€é…ç½®**åçš„å·¥ç¨‹æ¨¡æ¿èƒ½åŸºæœ¬æ»¡è¶³ä¸€ä¸ªå°å‹çš„ä¸šåŠ¡éœ€æ±‚ï¼Œå¦‚æœè¿˜æœ‰å…¶ä»–è¦æ±‚çš„è¯å¯ä»¥å¢å‡åŠŸèƒ½æˆ–è€…ä¿®æ”¹æŸäº›é…ç½®æ¥é€‚é…ï¼Œæ€»ä½“è¿˜æ˜¯çœ‹**å›¢é˜Ÿè‡ªèº«çš„ä¸šåŠ¡éœ€æ±‚æ¥å®šåˆ¶**ï¼Œæ¯”å¦‚å›¢é˜Ÿä¸­æœ‰`ç»Ÿä¸€æƒé™æ§åˆ¶çš„æ’ä»¶`æˆ–è€…`æ„å»ºæœåŠ¡çš„è„šæœ¬`éƒ½å¯ä»¥æ”¾åœ¨å·¥ç¨‹æ¨¡æ¿ä¸­ï¼Œæ–¹ä¾¿å…¶ä»–åŒå­¦å¼€ç®±å³ç”¨ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å¯¹ `NestJS` æœ‰äº†åˆæ­¥äº†è§£ã€‚ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†æ­£å¼ä½¿ç”¨ `NestJS` å¼€å‘ä¸šåŠ¡éœ€æ±‚ã€‚

å¦‚æœä½ æœ‰ä»€ä¹ˆç–‘é—®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæå‡ºæˆ–è€…åŠ ç¾¤æ²Ÿé€šã€‚ ğŸ‘