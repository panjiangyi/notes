## å‰è¨€

å‰ä¸¤ç« ï¼Œæˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†ç‰©æ–™ã€ç”¨æˆ·ç³»ç»Ÿçš„è®¾è®¡ä¸å¼€å‘ï¼Œåœ¨ç»è¿‡äº†ç”¨æˆ·ç³»ç»Ÿä¸ç‰©æ–™ç³»ç»Ÿçš„æŠ˜ç£¨ä¹‹åï¼Œå¤§å®¶åº”è¯¥å¯¹ `NestJS` å·²ç»éå¸¸çš„ç†Ÿæ‚‰äº†ï¼Œå­¦ä¹ æ—…é€”ä¹Ÿåˆ°äº†ç½‘å…³ç³»ç»Ÿä¸­**æœ€å…³é”®ä¸æ ¸å¿ƒ**çš„åŠŸèƒ½æ¨¡å—å¼€å‘ã€‚

ç”±äºç‰©æ–™ä¸ç½‘å…³æ ¸å¿ƒåŠŸèƒ½çš„è€¦åˆåº¦éå¸¸é«˜ï¼Œæ“ä½œèµ·æ¥éå¸¸éº»çƒ¦ï¼Œæ¯•ç«Ÿæˆ‘ä»¬æ²¡æœ‰çœŸå®çš„ç•Œé¢ï¼Œæ‰€ä»¥åœ¨æœ¬ç« å†…å®¹ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ `mock` æ•°æ®æ¥å®ç°ä»£ç†è½¬å‘çš„åŠŸèƒ½ï¼ŒåŒæ—¶å¯¹ç¼“å­˜æ•°æ®åšä¸€ä¸ªå¤§æ¦‚çš„ä»‹ç»ã€‚

## ç½‘å…³æ ¸å¿ƒç³»ç»Ÿå¼€å‘

#### æ‹¦æˆªè·¯ç”±

åœ¨éœ€æ±‚åˆ†æä¸­æˆ‘ä»¬æåˆ°äº†ï¼Œç½‘å…³åŸºç¡€æœåŠ¡ä½œä¸ºæ‰€æœ‰èµ„æºçš„å‰ç½®å…¥å£ï¼Œéœ€è¦å¯¹æ‰€æœ‰çš„è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œå†æ ¹æ®è¯·æ±‚çš„ç±»å‹åˆ†å‘åˆ°å¯¹åº”çš„æœåŠ¡æˆ–è€…è¿”å›éœ€æ±‚çš„èµ„æºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¥å—æ‰€æœ‰è¯·æ±‚çš„ `Controller`ã€‚

æ–°å»º `src/core/intercepter.controller.ts` å¦‚ä¸‹æ‰€ç¤º

```ts
import { Public } from '@/auth/constants';
import {
  Controller,
  Get,
  Req,
  Res,
} from '@nestjs/common';
import { FastifyReply, FastifyRequest } from 'fastify';
@Controller()
export class IntercepterController {
  constructor() { }
  @Get()
  async getApp(@Req() req: FastifyRequest, @Res() res: FastifyReply) {
    res.send('html')
  }
}
```

> æ³¨æ„ï¼Œæ­¤æ—¶çš„ `getApp` å¼•å…¥äº† `@Res() res: FastifyReply`ï¼Œä¸èƒ½ç›´æ¥ `return` è¿”å›å€¼ï¼Œéœ€è¦ä½¿ç”¨ `res.send` æ¥è¿”å› `html` æ ¼å¼

æ–°å»º `src/core/intercepter.module.ts`ï¼Œå¹¶åœ¨ `app.module.ts` ä¸­å¯¼å…¥ã€‚

```ts
import { Module } from '@nestjs/common';

import { IntercepterController } from './intercepter.controller';

@Module({
  controllers: [IntercepterController],
})

export class IntercepterModule { }
```

ç„¶åè¯·æ±‚æ¥å£ http://localhost/api ï¼ˆ**ä¸ºäº†æ–¹ä¾¿åæœŸä¿®æ”¹ `DNS` æµ‹è¯•æœ¬åœ°åŸŸåï¼Œå¯ä»¥å°†é¡¹ç›®å¯åŠ¨ç«¯å£æ”¹æˆ 80**ï¼‰ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹è¿”å›å€¼ã€‚

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f51de1f90d414269a80034eabc35089e~tplv-k3u1fbpfcp-watermark.image?)

ä»å›¾ä¸Šçœ‹å‡ºï¼Œè¯·æ±‚è·¯å¾„æ˜¯æºå¸¦äº† `api` å‰ç¼€çš„ï¼Œå¹¶ä¸ç¬¦åˆæ‹¦æˆªå…¨éƒ¨è·¯ç”±çš„è¦æ±‚ï¼Œå¯ä»¥ä¿®æ”¹ `main.ts` ä¸­çš„ `setGlobalPrefix` æ–¹æ³•ï¼š

```diff
- app.setGlobalPrefix('api');
+ app.setGlobalPrefix('api', { exclude: ['*'] }); 
```

åŒæ—¶å†ä¿®æ”¹ `src/core/intercepter.controller.ts` ä¸­çš„ `getApp` çš„ `Get` é…ç½®ï¼š

```diff
- @Controller()
+ @Controller('*')
export class IntercepterController {
  constructor() { }
  @Get()
  async getApp(@Req() req: FastifyRequest, @Res() res: FastifyReply) {
    res.send('html')
  }
}
```

ç„¶åå†è®¿é—®å¦‚ä¸‹è·¯ç”±å¯¹æ¯”å³å¯ä»¥å‘ç°ï¼Œå½“è®¿é—®åˆ°é¡¹ç›®å·²å­˜åœ¨çš„æ¥å£æ—¶ï¼Œä¼šæ­£å¸¸èµ°ä¹‹å‰çš„ä¸šåŠ¡é€»è¾‘ï¼Œå½“è®¿é—®ä¸å­˜åœ¨çš„ä¸šåŠ¡é€»è¾‘è·¯ç”±æ—¶ï¼Œå°†ç»Ÿä¸€è¿›å…¥ `IntercepterController` ä¸­ï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2d0a80ad81024acda2f7330fad156d7f~tplv-k3u1fbpfcp-watermark.image?)

#### è§£æè·¯ç”±

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®åŸŸåæ¥åŒ¹é…ä¸åŒçš„è¿”å›é¡µé¢ï¼Œåœ¨ä¸Šä¸€æ­¥å·²ç»å°†é¡¹ç›®å¯åŠ¨ç«¯å£ä¿®æ”¹ä¸º **80**ï¼Œæ‰€ä»¥ç›´æ¥ä¿®æ”¹ç³»ç»Ÿçš„ `host` ç›®å½•ï¼Œæ¥ä¿®æ”¹åŸŸå `DNS` è§£æï¼Œä½¿ä¹‹æŒ‡å‘æœ¬åœ°æœåŠ¡ï¼Œç„¶åæµè§ˆå™¨è®¿é—®å³å¯ï¼š

```yaml
127.0.0.1 www.cookieboty.com
127.0.0.1 nginx.cookieboty.com
127.0.0.1 jenkins.cookieboty.com
127.0.0.1 gitlab.cookieboty.com
127.0.0.1 devops.cookieboty.com
127.0.0.1 fe.cookieboty.com
```

```diff
@Controller('*')
export class IntercepterController {
  constructor() { }
  @Get()
  async getApp(@Req() req: FastifyRequest, @Res() res: FastifyReply) {
-    res.send('html')
+    res.send(req.headers.host)
  }
}
```

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6bba855e6a4f4205855c0d55d933bc57~tplv-k3u1fbpfcp-watermark.image?)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `req.headers.host` æ¥æ‹¿åˆ°å¯¹åº”çš„åŸŸåæ¥åˆ¤æ–­è¿”å›èµ„æºï¼Œä½†æ˜¯ä»…ä»…æœ‰åŸŸåè‚¯å®šæ˜¯ä¸è¶³å¤Ÿçš„ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåŸŸåä¸‹é¢ä¼šå­˜åœ¨å¤šä¸ªå‰ç«¯é¡¹ç›®ï¼Œè¿™äº›å‰ç«¯é¡¹ç›®å¯ä»¥é€šè¿‡è·¯ç”±å‰ç¼€æ¥åŒºåˆ†ï¼Œä¾‹å¦‚ www.cookieboty.com/devops ã€www.cookieboty.com/jenkins ç­‰ç­‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿéœ€è¦å¯¹æ•´ä¸ª `url` è¿›è¡Œè§£æã€‚

åŒæ—¶ï¼Œä¹Ÿå­˜åœ¨ `SPA` é¡¹ç›®ä¸­ä½¿ç”¨ `history` çš„æƒ…å†µï¼Œè¿™æ ·çš„è¯å°±ä¼šå­˜åœ¨è™šæ‹Ÿè·¯ç”±ï¼ŒçœŸå®çš„è®¿é—®åœ°å€ä¸æµè§ˆå™¨è¯·æ±‚çš„åœ°å€ä¸åŒ¹é…çš„æƒ…å†µï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦æ¨¡æ‹Ÿ `Nginx` ä¸­çš„ `try_files` æ¨¡å¼ã€‚

`ç¬¬ä¸€æ­¥`ï¼šå€ŸåŠ© `url` åº“æ¥ç»„è£…è·¯ç”±
```diff
+ import { URL } from 'url';

export class IntercepterController {
  constructor() { }
  @Get()
  async getApp(@Req() req: FastifyRequest, @Res() res: FastifyReply) {
+   const urlObj = new URL(req.url, `http://${req.headers.host}`);
+   console.log('urlObj===>', urlObj)
    res.send(req.headers.host)
  }
}
```

è®¿é—®ä¹‹å‰çš„åŸŸåå¯ä»¥åœ¨æ§åˆ¶å°å¾—åˆ°å¦‚ä¸‹çš„ç»“æ„ï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3e7457f9da2d4868982713167018d3c6~tplv-k3u1fbpfcp-watermark.image?)

> å¯ä»¥çœ‹åˆ°æ§åˆ¶å°ä¸­æœ‰ä¸¤ç§æ‰“å°ï¼Œæ™®é€šçš„ `html` ä¼šè‡ªåŠ¨è¯·æ±‚ `favicon` èµ„æºï¼Œæˆ‘ä»¬åªéœ€è¦æ‹¦æˆªæ­£å¸¸çš„è¯·æ±‚ï¼Œè¿‡æ»¤æ‰ `favicon.ico` è¿™ç§ç±»å‹çš„è¯·æ±‚å³å¯ï¼Œæˆ–è€…è¿”å›ä¸€ä¸ªé€šç”¨çš„å°å›¾æ ‡ä¹Ÿè¡Œã€‚

**ç¬¬äºŒæ­¥**ï¼šä¿®æ”¹ `IntercepterController`ï¼Œæ·»åŠ è¯»å– `html` æ–¹æ³•ä¸åˆ¤æ–­ç©ºå¼‚å¸¸ï¼š

```
@Controller()
export class IntercepterController {
  constructor(private readonly intercepterService: IntercepterService) { }

  @Get('*')
  @Public()
  async getApp(@Req() req: FastifyRequest, @Res() res: FastifyReply) {
    const urlObj = new URL(req.url, `http://${req.headers.host}`);
    
    if (urlObj.pathname === '/favicon.ico') return res.send('ico');
    
    const html = await this.intercepterService.readHtml(urlObj);

   if (!html) return res.send('404');
   
    res.headers({
      'Content-Type': 'text/html',
    });
    res.send(html);
  }
}
```

**ç¬¬ä¸‰æ­¥**ï¼šæ–°å»º `src/core/intercepter.service.ts` æ·»åŠ  `IntercepterService`

```ts
import { Injectable } from '@nestjs/common';

import { WebSiteDataModel } from './types';
import { getMatchedSync } from './intercepter';
import { ConfigService } from '@nestjs/config';
import * as WebsitesMock from './websites_mock.json';
import * as FilesMock from './files_mock.json';

@Injectable()
export class IntercepterService {
  constructor() { }

  get websites(): Record<string, WebSiteDataModel> {
    return WebsitesMock as Record<string, WebSiteDataModel>
  }

  async readHtml(urlObj: URL) {
    const { data: matchedData } = getMatchedSync(urlObj, this.websites);
    if (!matchedData) return null
    const html = FilesMock[matchedData.pageId]
    return html;
  }
}
```

`files_mock.json`

```json
{
  "1": "devops",
  "2": "jenkins",
  "3": "nginx"
}
```

`websites_mock.json`

```json
{
  "www.cookieboty.com": {
    "/devops": {
      "lastModified": 1,
      "pageId": 1
    },
    "/jenkins": {
      "lastModified": 1,
      "pageId": 2
    },
    "/nginx": {
      "lastModified": 1,
      "pageId": 3
    }
  }
}
```

**ç¬¬å››æ­¥**ï¼šåˆ›å»ºè§£æ `url` çš„æ–¹æ³•ï¼Œè§£æè·¯ç”±åœ°å€ï¼Œä¾‹å¦‚å°† `devops/list`ã€`devops/detail` ç­‰è·¯ç”±å…¨éƒ¨æŒ‡å‘åˆ°æ ¹è·¯ç”±åœ°å€ `devops` çš„èµ„æºä¸Šï¼Œåœ¨ç¬¬ä¸‰æ­¥ä¸­çš„ `getMatchedSync` æ–¹æ³•å°±ç”¨ä½œæ­¤åˆ¤æ–­ï¼š

```ts
export const getMatchedSync = (
  urlObj: URL,
  websites: Record<string, WebSiteDataModel> = {},
): { path: string | undefined; data: PageModelItem | undefined } | undefined => {

  if (!urlObj.hostname) {
    return undefined;
  }

  const website = matchWebsite(urlObj.hostname, websites);

  if (!website) {
    return undefined;
  }

  const { data, path } = matchPath(website, urlObj.pathname);

  if (!data) {
    return { path: undefined, data: undefined };
  }

  return { data, path };
}
```

å…ˆç”± `matchWebsite` æ¥åŒ¹é… `host`ï¼Œè·å–åŒ¹é…æˆåŠŸçš„ `host` æ•°æ®ä¹‹åï¼Œå†ä½¿ç”¨ matchPath æ–¹æ³•è¿›è¡Œ `path` çš„åŒ¹é…ï¼š

``` ts
export const matchWebsite = (
  host: string,
  websites: Record<string, WebSiteDataModel>,
): WebSiteDataModel | undefined => {
  return websites[host];
}

export const matchPath = (
  website: WebSiteDataModel | undefined,
  targetPath: string,
): { path: string; data: PageModelItem } | undefined => {

  if (!website) return;

  const targetPathArr = splitPath(targetPath);

  if (targetPathArr.find((i) => i === '*')) {
    throw new Error(
      '[matchPath] website custome path include *, redirect to 404',
    );
  }

  // å…¨åŒ¹é…
  if (website[targetPath]) {
    return {
      path: targetPath,
      data: website[targetPath],
    };
  }

  // .html åç¼€ ä¸” ä¸ç­‰äº index.html,
  if (/\/[^\/]+\.html$/.test(targetPath) && !/\/index\.html/.test(targetPath)) {
    return {
      path: targetPath,
      data: website[targetPath],
    };
  }

  // é€šé…
  let matchLen = 0;
  let resultKey: string;
  Object.keys(website.path || {}).forEach((path) => {

    if (!path.startsWith('/')) path = `/${path}`;

    const pathArr = splitPath(path);
    // éå¿…é¡»å®¹é”™ï¼šä»…å…è®¸æœ€åä¸€ä¸ªå­—ç¬¦å‡ºç° *
    if (pathArr.slice(0, -1).find((i) => i === '*'))
      throw new Error('[matchPath] path include *');

    /**
     * éå†è·¯ç”±è§„åˆ™åˆ—è¡¨ï¼ŒåŒ¹é…å‘½ä¸­ç«‹å³åœæ­¢éå†
     */
    let currentMatchLen = 0;
    let currentResultKey: string;
    for (let i = 0; i < pathArr.length; i += 1) {
      if (targetPathArr[i] !== pathArr[i]) {
        currentMatchLen = 0;
        currentResultKey = undefined;
        return;
      } else if (undefined === targetPathArr[i]) {
        currentMatchLen = 0;
        currentResultKey = undefined;
        return;
      }
      currentMatchLen = i + 1;
      currentResultKey = path;
    }

    if (matchLen < currentMatchLen) {
      matchLen = currentMatchLen;
      resultKey = currentResultKey;
    }
  });

  return {
    path: resultKey,
    data: website.path[resultKey],
  };
}
```

#### è·å–èµ„æº

åœ¨è§£æè·¯ç”±çš„ç¬¬ä¸‰æ­¥ä¸­ï¼Œå¤§å®¶åº”è¯¥æ³¨æ„åˆ°åœ¨è·¯ç”±åŒ¹é…ä¸­ï¼Œæœ‰ **2** ä¸ª `mock json` æ–‡ä»¶ `websites_mock.json` ä¸ `files_mock.json`ï¼Œå®ƒæ˜¯ç”±ç‰©æ–™ç³»ç»Ÿä¸­çš„ `pages` ç»„æˆçš„ï¼Œå…·ä½“çš„ç»“æ„ä¸ºï¼š

```ts
/**
 * @description ç«™ç‚¹æ•°æ®æ¨¡å‹
 */
export interface WebSiteDataModel {
  /**
   * @description ç«™ç‚¹ä¸‹çš„æ‰€æœ‰ path è¡¨
   */
  [host: string]: {
    [path: string]: PageModelItem;
  }
}

export interface PageModelItem {
  /**
   * @description æœ€åä¿®æ”¹æ—¶é—´
   */
  lastModified?: number;

  /**
   * @description é¡µé¢ id
   */
  pageId?: number;
  
  /**
   * @description æƒé™
   */
  permissions?: Array<() => (boolean | Promise<boolean>) | boolean>;
}
```

æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ˜¯éœ€è¦é€šè¿‡ `pageId` å»æ•°æ®åº“æŸ¥è¯¢å‡ºå¯¹åº”çš„èµ„æºè¿”å›ï¼Œä¸è¿‡åœ¨ `mock` çš„æƒ…å†µçœç•¥äº†ï¼Œç°åœ¨æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ç»“æœå¦‚ä½•ï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b97b6feac96e49ecaf6f4ef51828c0c5~tplv-k3u1fbpfcp-watermark.image?)

> æ³¨æ„ http://www.cookieboty.com/jenkins/list ä¸ http://www.cookieboty.com/jenkins è¿™ä¸¤ä¸ªè·¯ç”±ï¼Œå®ƒå°±æ˜¯ä¹‹å‰æ‰€æåˆ°è¿‡çš„è™šæ‹Ÿè·¯ç”±åŒ¹é…ï¼Œå½“è®¿é—®çš„èµ„æºä¸º `SPA` é¡¹ç›®ä½¿ç”¨ `history` æ„å»ºçš„è¯ï¼Œ`jenkins` ä¹‹åæ‰€æœ‰çš„è·¯å¾„éƒ½éœ€è¦å¼ºåˆ¶æŒ‡å‘ `jenkins` è¿™ä¸ªè·¯ç”±ä¸Šã€‚

#### ç¼“å­˜

ç”±äºæˆ‘ä»¬æ˜¯é™æ€èµ„æºä»£ç†ï¼Œæ‰€ä»¥ä¸ºäº†è¾¾åˆ°æœ€å¿«çš„è®¿é—®é€Ÿåº¦ï¼Œç»™ç”¨æˆ·æä¾›æœ€é«˜çš„æ€§èƒ½ä½“éªŒï¼Œå¯ä»¥å€ŸåŠ© **3** å±‚ç¼“å­˜æ¥å®ç°ã€‚

**ç¬¬ä¸€å±‚ç¼“å­˜**ï¼šç”±å®¢æˆ·ç«¯è‡ªèº«åœ¨è®¿é—®ä¹‹åäº§ç”Ÿçš„åå•†ç¼“å­˜ï¼Œå½“è¯·æ±‚èµ„æºä¸å˜çš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·è®¿é—®çš„æ˜¯æœ¬åœ°èµ„æºï¼Œè¿™ä¸ªçŸ¥è¯†ç‚¹ï¼Œå¤§éƒ¨åˆ†çš„å‰ç«¯åŒå­¦éƒ½åº”è¯¥æŒæ¡çš„éå¸¸ç†Ÿæ‚‰ï¼Œè¿™é‡Œå°±ä¸å†æ‹“å±•äº†ã€‚æ¥ä¸‹æ¥ä»‹ç»ä¸€ä¸‹ï¼Œåœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­å¦‚ä½•åˆ©ç”¨ç¼“å­˜æ¥æé«˜è®¿é—®æ•ˆç‡ã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4c75a9135fbb4e10b1eeb3cbb14e0f62~tplv-k3u1fbpfcp-watermark.image?)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç¬¬äºŒå±‚ç¼“å­˜ä¸ç¬¬ä¸‰å±‚ç¼“å­˜åˆ†åˆ«æ˜¯ç¨‹åºè¿è¡Œæœ¬åœ°æœåŠ¡å™¨ä¸ **Redis** æœåŠ¡ã€‚

å½“ç¬¬ä¸€ä¸ªç”¨æˆ·åœ¨è®¿é—®é¡µé¢æ—¶ï¼Œå¦‚æœåœ¨æœ¬åœ°æ²¡æœ‰æŸ¥è¯¢åˆ°èµ„æºçš„è¯ï¼Œä¼šå‘ **Redis** æœåŠ¡è¯·æ±‚èµ„æºï¼Œå½“ **Redis** æœåŠ¡ä¹Ÿæ²¡æœ‰è¯·æ±‚åˆ°å¯¹åº”çš„èµ„æºçš„è¯ï¼Œæœ€åå†å»è¯·æ±‚ **MongoDB** è·å–ã€‚

åŒæ ·åœ¨æ¯ä¸€æ¬¡è¯·æ±‚åˆ°èµ„æºçš„æƒ…å†µä¸‹ï¼Œéƒ½ä¼šåœ¨å¯¹åº”çš„å±‚çº§ç¼“å­˜èµ„æºï¼Œè¿™æ ·ä»»ä¸€ä¸€ä¸ªç”¨æˆ·è®¿é—®èµ„æºä¹‹åï¼Œå°±ä¼šäº§ç”Ÿç¼“å­˜æ•°æ®ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ•°æ®åº“çš„è¯»å†™ï¼ŒåŒæ—¶æé«˜å“åº”é€Ÿåº¦ã€‚

å¯èƒ½æœ‰åŒå­¦è¯´ `Redis` è¿™ä¸€å±‚å¯ä»¥çœç•¥ï¼Œä½†ä¸€èˆ¬ç½‘å…³æœåŠ¡ä¹Ÿä¼šä½¿ç”¨åˆ†å¸ƒå¼éƒ¨ç½²æ–¹å¼ï¼Œåœ¨åˆ†å¸ƒå¼æ¶æ„ä¸­ä½ å‘½ä¸­çš„æœåŠ¡ä¸ä¸€å®šæ˜¯åœ¨æœ¬åœ°æœ‰ç¼“å­˜äº†ï¼Œæ‰€ä»¥å³ä½¿ä¸¢å¤±æœ¬åœ°ç¼“å­˜ï¼Œä¹Ÿä¸èƒ½èˆå¼ƒ `Redis`ï¼Œå½“ä»»ä¸€çš„æœåŠ¡å‘½ä¸­èµ„æºä¹‹åï¼Œéƒ½ä¼šåœ¨ `Redis` ä¸­äº§ç”Ÿç¼“å­˜ï¼Œå…¶ä»–çš„æœåŠ¡ä¹Ÿå¯ä»¥å…±äº«ç¼“å­˜æ•°æ®ã€‚

å¦å¤–åœ¨æœ¬åœ°ç¼“å­˜ä¸­ï¼Œç”±äºä¼šå­˜å‚¨å¤§é‡çš„æ–‡ä»¶ï¼Œæ‰€ä»¥ä¹Ÿä¼šå­˜åœ¨æ—§ç‰ˆèµ„æºå†—ä½™çš„æƒ…å†µï¼Œæ‰€ä»¥åœ¨ä¹‹å‰çš„è®¾è®¡ä¸­ï¼Œæ°¸è¿œéƒ½åªä¿å­˜æœ€æ–°çš„èµ„æºäº§ç‰©ï¼Œä¸ä¼šä¿ç•™å†å²äº§ç‰©ï¼Œé€šè¿‡ `lastModified` å‚æ•°æ¥åˆ¤æ–­éœ€è¦æ›´æ–°èµ„æºã€‚

å½“èµ„æºè¿‡å¤šçš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥ä½¿ç”¨ `LRU` ç®—æ³•æ¥æ¸…ç©ºæœ¬åœ°èµ„æºï¼Œçœ‹éœ€æ±‚è¿›è¡ŒåŠŸèƒ½æ‹“å±•å³å¯ï¼Œå¤§å®¶å°½æƒ…å‘æŒ¥ï¼Œä¸ç”¨å®¢æ°”ã€‚

> åœ¨ç¼“å­˜çš„å·¥å…·é€‰æ‹©ä¸Šï¼Œå¤§å®¶å¯ä»¥é€‰æ‹©è‡ªå·±ç†Ÿæ‚‰çš„å·¥å…·å³å¯ï¼Œåªæ˜¯ `NestJS` è‡ªå¸¦çš„ç¼“å­˜æ’ä»¶å¯¹æ¥ `Redis` æ¯”è¾ƒæ–¹ä¾¿ï¼Œå¹¶ä¸ä»£è¡¨ä½ ä¸€å®šè¦ä½¿ç”¨ `Redis` æ‰è¡Œï¼Œæ¯”å¦‚æˆ‘ä»¬å…¬å¸ç›®å‰çš„ç¼“å­˜ä½¿ç”¨çš„æ˜¯ `Nacos`ã€‚

## å†™åœ¨æœ€å

æœ¬ç« çš„ä»£ç åœ°å€ä¸º [feat/core](https://github.com/boty-design/gateway/tree/feat/core)ï¼Œéœ€è¦çš„åŒå­¦è‡ªå–ï¼Œä¼šæŒç»­æ›´æ–°ã€‚

ç”±äºç¯‡å¹…æ‰€é™ï¼Œæ–‡ç« é‡Œé¢æåˆ°çš„å¼€å‘å†…å®¹æ¯”è¾ƒå°‘ï¼Œåªæœ‰æœ€æ ¸å¿ƒçš„ä¸¤ä¸ªåŠŸèƒ½ï¼Œå…¶ä»–çš„åŠŸèƒ½å¯ä»¥ç­‰å¾…å®Œæ•´çš„é¡¹ç›®å‡ºæ¥ä¹‹åå†å¯¹æ¯”å­¦ä¹ å³å¯ï¼Œä¸€èˆ¬å…³é”®çš„åœ°æ–¹æˆ‘ä¼šåšå¿…è¦çš„æ³¨é‡Šï¼Œå¦‚æœè¿˜æœ‰å…¶ä»–çš„é—®é¢˜å¯ä»¥åŠ ç¾¤è®¨è®ºæˆ–è€…ç›´æ¥è”ç³»æˆ‘éƒ½è¡Œã€‚

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»é™†é™†ç»­ç»­å¼€å‘ **3** ä¸ªå¤§çš„åŠŸèƒ½æ¨¡å—ï¼Œå¤§å®¶åº”è¯¥èƒ½æ„Ÿè§‰åˆ°ç›®å‰çš„å·¥ç¨‹å·²ç»å¾ˆåºå¤§äº†ï¼Œå¦‚æœæ˜¯æ™®é€šå¼€å‘æ¨¡å¼çš„è¯ï¼Œæ¯ä¸€æ¬¡çš„é‡å¯é€Ÿåº¦å·²ç»å˜æ…¢ã€‚

æ•´ä¸ªé¡¹ç›®ç›®å‰å·²ç»æœ‰ **40+** ä¸ªæ¥å£ï¼Œå¦‚æœç‰©æ–™ç³»ç»Ÿå†å¤æ‚ç‚¹çš„è¯ï¼Œå·²ç» **50+** çš„æ¥å£ä¸åœ¨è¯ä¸‹ã€‚è€Œè¿™åªæ˜¯ `Controller` çš„æ•°é‡ï¼Œå¹¶æœªæ‹¬å·¥å…·ç±»ä¸ `Service` å±‚çš„ä»£ç ã€‚

æ‰€ä»¥åœ¨æ¥ä¸‹æ¥ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†å¯¹è¿™ä¸ªé€æ¸å˜æˆå·¨çŸ³çš„å·¥ç¨‹è¿›è¡Œé¡¹ç›®æ‹†åˆ†ï¼Œé™ä½é¡¹ç›®ä¹‹é—´çš„è€¦åˆåº¦ï¼Œåšåˆ°ç‹¬ç«‹éƒ¨ç½²ä¸ç‹¬ç«‹å¼€å‘ã€‚

å¦‚æœä½ æœ‰ä»€ä¹ˆç–‘é—®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæå‡ºæˆ–è€…åŠ ç¾¤æ²Ÿé€šã€‚ ğŸ‘