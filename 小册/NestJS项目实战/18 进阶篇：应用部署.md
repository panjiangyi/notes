## å‰è¨€

æŒ‰ç…§ç›®å‰çš„è¿›åº¦ï¼Œç›¸ä¿¡å¾ˆå¤šåŒå­¦å·²ç»å®ŒæˆåŸºç¡€ç¯‡çš„å†…å®¹ï¼Œä¹Ÿæœ‰éƒ¨åˆ†åŒå­¦å®Œæˆäº†ç”¨æˆ·æˆ–è€…ç‰©æ–™ç³»ç»Ÿçš„å¼€å‘ï¼Œæ‰€ä»¥åº”å¹¿å¤§åŒå­¦çš„è¦æ±‚ï¼Œå°†åº”ç”¨éƒ¨ç½²è¿™ç« æå‰å†™å‡ºæ¥ï¼Œæ–¹ä¾¿å¤§å®¶å®Œæˆé¡¹ç›®å¼€å‘æµç¨‹ä¸­å…³é”®çš„æœ€åä¸€æ­¥ã€‚

ä¸å¼€å‘ç¯å¢ƒä¸åŒï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æœåŠ¡ç«¯çš„é¡¹ç›®éƒ½éœ€è¦åå°å¯åŠ¨ï¼Œå¦‚æœæ˜¯å‰ç«¯å¯åŠ¨çš„è¯ï¼Œå½“ä½ å…³é—­ `ssh` è¿æ¥æˆ–è€…æ§åˆ¶å°çš„æ—¶å€™ï¼Œç¨‹åºä¹Ÿå°±è‡ªåŠ¨é€€å‡ºäº†ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬å¸Œæœ›çš„ç»“æœã€‚

æœ¬ç« å°†ä»‹ç» `NestJS` ä¸¤ç§æ–¹å¼çš„å‘å¸ƒç±»å‹ï¼š `PM2` ä¸ `Docker Compose` éƒ¨ç½²ã€‚

## PM2

[PM2](https://pm2.keymetrics.io/docs/usage/quick-start/) æ˜¯ä¸€æ¬¾ä½¿ç”¨äºç”Ÿäº§ç¯å¢ƒçš„ `NodeJS` çš„è¿›ç¨‹ç®¡ç†å·¥å…·ï¼Œæ“ä½œéå¸¸ç®€ä¾¿ï¼Œå†…ç½®äº†è¿›ç¨‹ç®¡ç†ã€ç›‘æ§ã€æ—¥å¿—ä»¥åŠè´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ã€‚

é¦–å…ˆéœ€è¦å®‰è£… `PM2` çš„ä¾èµ–ï¼Œä¸€èˆ¬ä¼šå®‰è£…åœ¨å…¨å±€ä¾èµ–ï¼š

```shell
$ yarn global add pm2
```

æ™®é€šçš„å‰ç«¯é¡¹ç›®å¯åŠ¨çš„è¯ï¼Œç›´æ¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°±è¡Œäº†ï¼š

```shell
pm2 start app.js
```
ä½†æ¯•ç«Ÿæ˜¯è¿™ä¸€ä¸ªå®æˆ˜çš„é¡¹ç›®è€Œä¸”ä¹Ÿæœ‰ä¸åŒçš„ç¯å¢ƒå˜é‡å­˜åœ¨ï¼Œç›´æ¥è¿™ä¹ˆå¯åŠ¨å¹¶ä¸åˆé€‚ï¼Œå¯ä»¥å€ŸåŠ© `Ecosystem File` æ¥å®Œæˆæˆ‘ä»¬çš„éœ€æ±‚ã€‚

1. é¡¹ç›®æ ¹ç›®å½•æ–°å»º `ecosystem.config.js`ï¼š
```js
module.exports = {
  apps: [
    {
      name: "gateway",
      script: "dist/src/main.js",
      env_production: {
        RUNNING_ENV: "prod"
      },
      env_development: {
        RUNNING_ENV: "dev"
      }
    }
  ]
}
```

2. æ·»åŠ  `package.json` ä¸­çš„ `scripts` æ„å»ºå‘½ä»¤ï¼š
```diff
+ "build": "nest build",
+ "build:webpack": "nest build --webpack",
```

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f9413666d6ab417bb3a04f8387bab393~tplv-k3u1fbpfcp-watermark.image?)

å¯¹æ¯”ä¸€ä¸‹ä¸¤ç§æ„å»ºå‘½ä»¤çš„ä¸åŒç‚¹ï¼š
- `nest build`ï¼šå°† `NestJS` é¡¹ç›®çš„æºç ä» `TS` ç¼–è¯‘æˆ `JS` ä¹‹åå†ä½¿ç”¨ `node main.js` æ¥è¿è¡Œé¡¹ç›®ï¼Œè¿™æ ·æœ‰ä¸ªå¥½å¤„æ˜¯è¿˜èƒ½çœ‹åˆ°å¤§æ¦‚çš„å·¥ç¨‹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ `TypeOrm` åŠ¨æ€æ³¨å†Œå®ä½“ç±»çš„åŠŸèƒ½ã€‚
- `nest build --webpack` ä¼šå°† `NestJS` é¡¹ç›®æ‰“åŒ…æˆä¸€ä¸ªç‹¬ç«‹çš„ `main.js`ï¼Œä»æ–‡ä»¶ç±»å‹çš„è§’åº¦æ¥è¯´ï¼Œåšäº†ä¸€æ¬¡æ··æ·†è·Ÿåˆå¹¶ï¼ŒåŸç†è·Ÿä¹‹å‰æåˆ°è¿‡çš„çƒ­æ›´æ–°å¯åŠ¨æ˜¯ä¸€æ ·çš„ï¼ŒæŒ‰ç…§è¿™ç§æ¨¡å¼çš„è¯æ¥ä½¿ç”¨çš„è¯ï¼Œ**å°±ä¸èƒ½ä½¿ç”¨åŠ¨æ€æ³¨å†Œå®ä½“ç±»çš„åŠŸèƒ½ï¼Œåªèƒ½æ‰‹åŠ¨å¼•å…¥å®ä½“ç±»**ã€‚

ä¸¤ç§æ„å»ºäº§ç‰©çš„æ–¹å¼éƒ½å¯ä»¥å®Œæˆè¦æ±‚ï¼ŒæŒ‰ç…§è‡ªå·±çš„å–œå¥½é€‰æ‹©å°±è¡Œï¼Œä½†æ— è®ºæ˜¯ `webpack` æ‰“åŒ…æˆå•æ–‡ä»¶çš„æ¨¡å¼è¿˜æ˜¯ä½¿ç”¨ `TSC` æ¨¡å¼ç”Ÿæˆ `JS` é¡¹ç›®ä»£ç ï¼Œéƒ½éœ€è¦åœ¨å‘å¸ƒå·¥ç¨‹é‡Œé¢æ·»åŠ  `node_modules`ï¼Œå¦åˆ™æ˜¯æ²¡åŠæ³•æ­£å¸¸å¯åŠ¨ã€‚

å› ä¸ºè¿™ä¸¤ç§æ¨¡å¼å¹¶æ²¡æœ‰å°†ä¾èµ–ç›´æ¥æ‰“åŒ…è¿›äº§ç‰©å†…ï¼Œè™½ç„¶å¯ä»¥æ›²çº¿ä¿®æ”¹ `webpack.config` å¯ä»¥ä½¿å¾—åœ¨ `webpack` æ¨¡å¼ä¸‹ï¼Œèƒ½å°†æ‰€æœ‰çš„ä¾èµ–éƒ½æ‰“å…¥å•æ–‡ä»¶ï¼Œä½†æ˜¯ç”±äºç¯å¢ƒä¾èµ–çš„é—®é¢˜ï¼Œè¿™ç§æ¨¡å¼çš„äº§ç‰©å¤§æ¦‚ç‡åªèƒ½åœ¨ç›¸åŒçš„ç¯å¢ƒè¿è¡Œä¾èµ–ï¼Œä¾‹å¦‚ `windows` ä¸‹æ‰“åŒ…çš„äº§ç‰©æ˜¯æ— æ³•éƒ¨ç½²åœ¨ `linux` ç¯å¢ƒä¸‹ã€‚

3. åœ¨ `package.json` çš„ `scripts` ä¸­æ·»åŠ å¯åŠ¨è„šæœ¬ï¼š
```diff
+ "start:prod": "nest build && pm2 start ecosystem.config.js --env production"
```

æ·»åŠ å®Œæ¯•ä¹‹åï¼Œæ‰§è¡Œ `yarn start:prod` å‡ºç°å¦‚ä¸‹ç•Œé¢æ—¢å®Œæˆäº†é¡¹ç›®ç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²ï¼Œå¦‚æœä¸èƒ½æ­£å¸¸è®¿é—®æ¥å£çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ `pm2 log gateway` æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼Œå¦‚æœæŒ‰ç…§æˆ‘ç»™çš„æ–¹æ¡ˆèµ°ä¸€èˆ¬ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œæœ‰é—®é¢˜çš„è¯ï¼Œå¤§æ¦‚ç‡æ˜¯é…ç½®æ–‡ä»¶æ‰¾ä¸åˆ°ï¼Œè°ƒæ•´é…ç½®æ–‡ä»¶å³å¯ã€‚

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9e6ebe6ebbc04661893303c0aa76ba47~tplv-k3u1fbpfcp-watermark.image?)

> **åˆ‡è®°ï¼Œå¦‚æœä½¿ç”¨ webpack æ¨¡å¼éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒï¼Œä¸€å®šè¦æ‰‹åŠ¨æ³¨å†Œå®ä½“ç±»ï¼ï¼ï¼ï¼ä¸ç„¶ä¼šæŠ¥é”™çš„ï¼ï¼ï¼ï¼**

æ›´å¤šçš„ `PM2` çš„ `API` ä½¿ç”¨ä¸é»‘ç§‘æŠ€ï¼Œç”¨å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±è¿›è¡Œæ‘¸ç´¢ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šä»‹ç»äº†ã€‚

## Docker Compose

`Docker Compose` é¡¹ç›®æ˜¯ `Docker` å®˜æ–¹çš„å¼€æºé¡¹ç›®ï¼Œè´Ÿè´£å®ç°å¯¹ `Docker` å®¹å™¨é›†ç¾¤çš„å¿«é€Ÿç¼–æ’æ—¥å¸¸å¼€å‘å·¥ä½œä¸­ï¼Œç»å¸¸ä¼šç¢°åˆ°éœ€è¦å¤šä¸ªå®¹å™¨ç›¸äº’é…åˆæ¥å®ŒæˆæŸé¡¹ä»»åŠ¡çš„æƒ…å†µã€‚

æ¯”å¦‚æˆ‘ä»¬çš„ç½‘å…³æœåŠ¡ä½“ç³»å°±ç”± **3** ä¸ªä¸åŒçš„æœåŠ¡ç»„æˆï¼Œå…¶ä¸­è¿˜ä¸åŒ…æ‹¬ `Redis`ã€`Mysql` è¿™ç§ä¸­é—´ä»¶çš„æœåŠ¡ï¼Œæ‰€ä»¥æ¯ä¸ªæœåŠ¡éƒ½ä½¿ç”¨ç›´æ¥ `Docker` æ¥éƒ¨ç½²çš„è¯ï¼Œæ•ˆç‡ä½ä¸‹è€Œä¸”ç»´æŠ¤éº»çƒ¦ï¼Œè€Œå€ŸåŠ© `Docker Compose` å¯ä»¥å°†æˆ‘ä»¬çš„æœåŠ¡ç»Ÿä¸€ä¸€æ¬¡æ€§éƒ¨ç½²å®Œæˆã€‚

**ç¬¬ä¸€æ­¥**ï¼šè¦æŠŠé¡¹ç›®å·¥ç¨‹æ‰“åŒ…æˆ `image`ï¼Œæ ¹è·¯å¾„åˆ›å»ºæ–‡ä»¶ `Dockerfile`:
```
FROM node:16-alpine3.15

RUN mkdir -p /home/app/

WORKDIR /home/app/

COPY package*.json ./

RUN npm install

COPY . .

EXPOSE 3000

ENTRYPOINT ["npm", "run"]

CMD ["start"]
```

**ç¬¬äºŒæ­¥**ï¼šæ ¹ç›®å½•è¿è¡Œä»¥ä¸‹è„šæœ¬æ¥å°±è¡Œæ„å»ºï¼š

```shell
$ docker build -f ./Dockerfile -t gateway:0.0.1 .
```

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1c719d5ac1ad49b58bdc554c7e672868~tplv-k3u1fbpfcp-watermark.image?)

**ç¬¬ä¸‰æ­¥**ï¼šè¿è¡Œä»¥ä¸‹å‘½ä»¤æ—¢å¯ä»¥å¯åŠ¨å®¹å™¨è¿è¡Œï¼š

```shell
docker run -d -e RUNNING_ENV=prod -p 3000:3000 gateway:0.0.1
```

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/18c0205306a64373a6361e6ee15438eb~tplv-k3u1fbpfcp-watermark.image?)

ä½¿ç”¨ `docker logs [å®¹å™¨id] `æ—¢å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„é¡¹ç›®å·²ç»æ­£å¸¸å¯åŠ¨äº†ï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c22bfa0ebc0b47ca95ede19bfd303fd0~tplv-k3u1fbpfcp-watermark.image?)


ä»¥ä¸Šæ˜¯ç›´æ¥ä½¿ç”¨ `Docker` æ¥éƒ¨ç½²é¡¹ç›®ï¼Œæ¢æˆ `Docker Compose` çš„è¯ï¼Œåˆ™éœ€è¦é¢å¤–æ–°å»ºæ–‡ä»¶ `docker-compose.gateway-service-dev.yml`ï¼š
```
version: "3"
services:
  gateway-service-dev:
    container_name: gateway-service-dev
    build:
      context: ./
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      RUNNING_ENV: 'dev'
    networks:
      - servicebus
networks:
  servicebus:
    name: servicebus
```
å¯åŠ¨å‘½ä»¤ä¸ºï¼š

```shell
docker-compose -f docker-compose.gateway-service-dev.yml up -d  --build
```
å…¶ä¸­ `build` å‚æ•°ä»£è¡¨æ„å»ºè¿‡ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨ docker-compose æ„å»ºçš„æ—¶å€™å¯ä»¥çœå»ç¬¬äºŒæ­¥æ„å»ºé•œåƒçš„æ­¥éª¤ï¼Œé…åˆ `docker file` ä¸­çš„å‰ç½®å®‰è£…ä¾èµ–æ­¥éª¤ï¼Œå¯ä»¥åœ¨æ¯æ¬¡æ›´æ–°ä»£ç åéœ€è¦é‡æ–°æ„å»ºæ—¶ï¼Œé¡¹ç›®ä¾èµ–ä¸æ›´æ–°çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ç¼“å­˜æ„å»ºï¼Œå¤§å¹…åº¦å‡å°‘æ„å»ºæ—¶é—´ã€‚

## å†™åœ¨æœ€å

éƒ¨ç½²ç¯‡çš„ç« èŠ‚ä¸ºäº†æ–¹ä¾¿å¤§å®¶å¿«é€Ÿä½¿ç”¨ï¼Œç›®å‰è¾ƒä¸ºç®€å•ï¼Œç­‰å¾…æ‰€æœ‰çš„é¡¹ç›®éƒ½å®Œæˆä¹‹åï¼Œä¼šåœ¨ `docker compose` éƒ¨åˆ†æ‰©å……å†…å®¹ï¼Œç»™å¤§å®¶å±•ç¤ºå®¹å™¨ç¼–æ’çš„ä¼˜åŠ¿ã€‚

å¦å¤–å¦‚æœæœ‰æœºä¼šæˆ–è€…æƒ³å°è¯• `K8S` éƒ¨ç½²çš„è¯ï¼Œå¯ä»¥å‚è€ƒ `Devops` çš„å°å†Œï¼Œé‡Œé¢æœ‰ `Rancher` ç« èŠ‚æ˜¯å…³äºé›†ç¾¤éƒ¨ç½²çš„

å¦‚æœä½ æœ‰ä»€ä¹ˆç–‘é—®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæå‡ºæˆ–è€…åŠ ç¾¤æ²Ÿé€šã€‚ ğŸ‘